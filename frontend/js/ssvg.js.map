{"version":3,"sources":["webpack://SSVG/webpack/universalModuleDefinition","webpack://SSVG/webpack/bootstrap","webpack://SSVG/./canvasworker/drawingUtils.ts","webpack://SSVG/./frontend/exporter.ts","webpack://SSVG/./frontend/ssvg.ts","webpack://SSVG/./frontend/domhandler.ts","webpack://SSVG/./util/vdomManager.ts","webpack://SSVG/./canvasworker/canvasrenderer.ts","webpack://SSVG/./canvasworker/index.ts","webpack://SSVG/./canvasworker/canvasworker.ts","webpack://SSVG/./node_modules/worker-loader/dist/workers/InlineWorker.js"],"names":["root","factory","exports","module","define","amd","window","installedModules","__webpack_require__","moduleId","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","DrawingUtils","[object Object]","transform","transformObject","translateX","translateY","scaleX","scaleY","rotate","translateBeforeScale","transformString","replace","translate","exec","parseFloat","scale","matrix","transformA","transformB","size","fallback","defaultValue","undefined","substr","Math","round","parseInt","match","console","warn","color","opacity","CssNamedColorToHex","test","substring","length","join","Error","g","b","rgb","hslToRgb","h","hue2rgb","q","default","ssvg_1","domhandler_1","__importDefault","canvasrenderer_1","drawingUtils_1","canvasworker_1","options","this","unassignedNodes","interactionSelections","svgAssignedAndSizeSet","lastTenCanvasDrawTimes","enterExitQueue","safeMode","useWorker","getFps","onDrawn","maxPixelRatio","canvas","document","createElement","worker","onmessage","e","data","msg","logDrawn","updateCanvas","raf","updateFps","requestAnimationFrame","captureD3On","setupElementsIfSvgExists","addEventListener","propagateMouseEvent","lastHovered","hoveredElement","dispatchEvent","MouseEvent","propagateWheelEvent","replaceNativeRemoveChild","replaceNativeAttribute","replaceNativePathFunctions","replaceNativeCreateElement","replaceNativeAppendChild","replaceD3Attr","replaceNativeSelect","replaceNativeGetComputedStyle","replaceD3Select","replaceD3Remove","setTimeout","log","vdom","svgEl","svg","getElementsByTagName","urlConnector","location","href","indexOf","svgSwitchUrl","svgSwitchComment","createComment","parentElement","appendChild","domHandler","getVDom","setCanvasSize","useAttrQueue","queue","keys","sendUpdateToWorker","renderer","updatePropertiesFromQueue","draw","width","height","devicePixelRatio","style","offscreen","transferControlToOffscreen","sendToWorker","cmd","visData","element","isWithinSvg","parentEl","parentNode","d3","originalOn","selection","on","me","el","_parents","children","push","apply","arguments","getReplacement","original","selector","_groups","error","node","getVisNode","childElements","getVisNodesFromSelector","map","getElementFromNode","returnValue","forEach","childNode","childEl","selectAll","select","origFilter","filter","selectorString","elements","firstElement","getNodeFromElement","nodes","selectors","split","sel","trim","filteredNodes","matchingNodes","filterNodesBySelector","filteredElements","origGetComputedStyle","getComputedStyle","getPropertyValue","propertyName","origQuerySelector","Element","querySelector","childNodes","globalElementIndex","originalFct","prefix","els","returnVal","getAttributeFromSelector","getElementSelector","getVisNodeFromSelector","child","queueSetAttributeOnElement","queueSetAttributeOnSelection","origSelectionAttr","attr","origSelectionStyle","originalClassed","classed","className","enableFrontendDesignProperties","indexOfParent","childIndex","parentSelector","parent","getParentNodeFromSelector","prevClassNames","evaluatedValue","__data__","newClassNames","originalTransition","transition","originalText","text","newRemove","getNewRemoveChild","d3Remove","updateChildSelectors","remove","origCreate","createElementNS","newArgs","Array","from","getNewAppendChild","childElement","oldSelector","combineElementSelectors","type","updateNodeSelector","origRemoveChild","skipUpdateSelectors","removeChild","writable","parentNodeSelector","removeNodeFromParent","origAppend","appended","el2","keepChildren","getNodeDataFromEl","setProperty","styleProp","linkNodeToElement","addNodeToParent","addNode","index","splice","origAppendChild","newAppend","insertBefore","newChild","refChild","origGetTotalLength","SVGPathElement","getTotalLength","getAttribute","origSetAttribute","origSetAttr","setAttribute","origSetAttrNS","setAttributeNS","origGetAttr","evt","propagateEvent","WheelEvent","new_event","triggeredElement","interactionSel","j","vdomNode","nodeAtPosition","clientX","clientY","svgChildEl","visNode","x","y","cx","cy","parseTransform","sqrt","pow","elX","elY","centerX","centerY","distanceX","abs","distanceY","getTotalTransformation","matchAny","Date","now","shift","timeForTenDrawsMs","fps","enterExit","update","postMessage","vdomManager_1","drawingUtils_2","ignoreDesign","sharedArrays","setAttrQueue","nodesToElements","nodesToRestyle","useSharedArrayFor","VdomManager","display","addChildNodesToVisData","attrName","safeLog","checkAttrName","styleName","useSharedArray","self","useBuffer","buffer","SharedArrayBuffer","Int32Array","BYTES_PER_ELEMENT","cb","applyStyles","getRoundedAttr","val","tagName","toLowerCase","id","fill","x1","x2","y1","y2","stroke-width","textContent","font-size","font","text-anchor","obj","propNames","getOwnPropertyNames","propName","clean","styleSheets","sheet","rules","cssRules","rule","selectorText","applyRuleToMatchingNodes","newSelector","selectorPartsLooseStrict","part","parentsOfInterest","nodeToBeStyled","getNodeParent","checkNode","currentNode","looseIndex","strictIndex","selPart","isCssRulePartialMatch","getNodeSelector","stroke","removeRuleStylesFromNode","colorToRgba","removeNode","childEls","localName","elementType","elementIndex","getParentNode","parents","pop","totalTransform","addTransforms","safeLogCount","logContents","SetPropertyQueue","cachedListSelections","nodeData","applyParentStyles","styleValue","applyStyleToNodeAndChildren","attrNameStart","values","factor","updateDeducedStyles","ROUNDED_ATTRS","strokeOpacity","lastSplitPos","lastIndexOf","selectorWithoutLast","lastPart","parentSel","nthChildPosition","selectedNodes","findMatchingChildren","addDirectChildrenIfMatch","matchIndex","selectedNodeSelectors","selParts","findChildrenOfType","matching","cssRuleSelectorPart","newSelPart","indexPart","targetIndex","cutoff","typeName","forceSingle","lastFullSecond","countSinceLastFullSecond","circlesByColor","rectsByColor","drawTexts","linesByColor","ctx","getContext","save","restore","clearRect","drawLine","drawCircle","drawRect","drawText","drawNodeAndChildren","fullSecond","performance","elData","applyTransform","drawSingleNode","drawFct","toUpperCase","fillOpacity","handle","getStrokeStyle","beginPath","fillStyle","strokeStyle","lineWidth","strokeWidth","arc","PI","fillAndStrokeColor","fillColor","strokeColor","sampleData","moveTo","fillOpacityStyle","fillRect","rect","drawSingle","fontSize","convertSizeToPx","align","textAlign","dx","dy","fillText","getFillStyle","Path2D","lineJoin","textAnchor","lineTo","CanvasWorkerImporter","URL","webkitURL","content","url","blob","BlobBuilder","WebKitBlobBuilder","MozBlobBuilder","MSBlobBuilder","append","getBlob","Blob","Worker","createObjectURL","encodeURIComponent"],"mappings":"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","file":"ssvg.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"SSVG\"] = factory();\n\telse\n\t\troot[\"SSVG\"] = factory();\n})(window, function() {\nreturn "," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 1);\n","export type Transformation = {\r\n    translateX: number,\r\n    translateY: number,\r\n    scaleX: number,\r\n    scaleY: number,\r\n    rotate: number\r\n}\r\n\r\nexport default class DrawingUtils {\r\n    static parseTransform(transform: string|{}): Transformation {\r\n        const transformObject = {translateX: 0, translateY: 0, scaleX: 1, scaleY: 1, rotate: 0, translateBeforeScale: false};\r\n        \r\n        if (transform) {\r\n            if(typeof transform !== \"string\") {\r\n                transformObject.scaleX = transform['k'];\r\n                transformObject.scaleY = transform['k'];\r\n                transformObject.translateX = transform['x'];\r\n                transformObject.translateY = transform['y'];\r\n                return transformObject;\r\n            }\r\n            let transformString = <string> transform;\r\n            transformString = transformString.replace(/ /g, '');\r\n            \r\n            //let translate  = /translate\\((\\d+),(\\d+)\\)/.exec(transform);\r\n            const translate = /\\s*translate\\(([-0-9.]+),([-0-9.]+)\\)/.exec(transformString);\r\n            if (translate) {\r\n                transformObject.translateX = parseFloat(translate[1]);\r\n                transformObject.translateY = parseFloat(translate[2]);\r\n            }\r\n            else {\r\n                //console.error('no translate found', transform);\r\n            }\r\n            \r\n            const scale = /\\s*scale\\(([-0-9.]+)\\)/.exec(transformString);\r\n            if (scale) {\r\n                transformObject.scaleX = parseFloat(scale[1]);\r\n                transformObject.scaleY = parseFloat(scale[1]);\r\n            }\r\n            else {\r\n                //console.error('no scale found', transform);\r\n            }\r\n            \r\n            const rotate = /\\s*rotate\\(([-0-9.]+)\\)/.exec(transformString);\r\n            if (rotate) {\r\n                transformObject.rotate = parseFloat(rotate[1]);\r\n            }\r\n            else {\r\n                //console.error('no rotate found', transform);\r\n            }\r\n            \r\n            const translateScale = /\\s*translate\\(([-0-9.]+),([-0-9.]+)\\)scale\\(([-0-9.]+)\\)/.exec(transformString);\r\n            if (translateScale) {\r\n                transformObject.translateBeforeScale = true;\r\n            }\r\n            \r\n            const matrix = /\\s*matrix\\(([-0-9.]+),([-0-9.]+),([-0-9.]+),([-0-9.]+),([-0-9.]+),([-0-9.]+)\\)/.exec(transformString);\r\n            if(matrix) {\r\n                transformObject.scaleX = parseFloat(matrix[1]);\r\n                // 2 is horizontal skewing\r\n                // 3 is vertical skewing\r\n                transformObject.scaleY = parseFloat(matrix[4]);\r\n                transformObject.translateX = parseFloat(matrix[5]);\r\n                transformObject.translateY = parseFloat(matrix[6]);\r\n            }\r\n        }\r\n        \r\n        return transformObject;\r\n    }\r\n\r\n    static addTransforms(transformA: Transformation, transformB: Transformation): Transformation {\r\n        return {\r\n            translateX: transformA.translateX + transformB.translateX,\r\n            translateY: transformA.translateY + transformB.translateY,\r\n            scaleX: transformA.scaleX * transformB.scaleX,\r\n            scaleY: transformA.scaleY * transformB.scaleY,\r\n            rotate: transformA.rotate + transformB.rotate\r\n        };\r\n    }\r\n\r\n    static convertSizeToPx(size: string|number, fallback = true): number|undefined {\r\n        const defaultValue = fallback ? 14 : undefined;\r\n        if(size === undefined) {\r\n            return defaultValue;\r\n        }\r\n        if(typeof size === \"number\") {\r\n            return size;\r\n        }\r\n        if(size.substr(-2) === 'em') {\r\n            return Math.round(parseFloat(size) * 12);\r\n        }\r\n        if(size.substr(-2) === 'px') {\r\n            return parseInt(size);\r\n        }\r\n        if(size.match(/^[0-9]+$/)) {\r\n            return parseInt(size);\r\n        }\r\n        console.warn('size in unsupported format: ', size);\r\n        return defaultValue;\r\n    }\r\n    \r\n    static colorToRgba(color: string|{r: number, g: number, b: number}|{h: number, s: number, l: number}, opacity: string|number = 1): string {\r\n        if(!color || color === 'none') {\r\n            return 'none';\r\n        }\r\n        color = DrawingUtils.CssNamedColorToHex(color);\r\n        if(opacity === 1 && typeof color === 'string') {\r\n            return color;\r\n        }\r\n        if(typeof color === 'string' && color[0] === '#') {\r\n            let c; // From https://stackoverflow.com/questions/21646738/convert-hex-to-rgba\r\n            if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(color)){\r\n                c = color.substring(1);\r\n                if(c.length == 3){\r\n                    c = c[0] + c[0] + c[1] + c[1] + c[2] + c[2];\r\n                }\r\n                c = '0x' + c;\r\n                return 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+',' + opacity + ')';\r\n            }\r\n            throw new Error('Bad Hex');\r\n        } else if(typeof color === 'object') {\r\n            if('r' in color) {\r\n                return 'rgba(' + color.r + ',' + color.g + ',' + color.b + ',' + opacity + ')';\r\n            }\r\n            if('h' in color) {\r\n                const rgb = DrawingUtils.hslToRgb(color.h / 360, color.s, color.l);\r\n                return 'rgba(' + rgb.r + ',' + rgb.g + ',' + rgb.b + ',' + opacity + ')';\r\n            }\r\n        } else if(color.substr(0, 4) === 'rgb(') {\r\n            return color.substr(0, color.length - 1).replace('rgb','rgba') +\r\n                ', ' + opacity + ')';\r\n        }\r\n        return color;\r\n    }\r\n\r\n    // From https://stackoverflow.com/questions/2353211/hsl-to-rgb-color-conversion\r\n    static hslToRgb(h, s, l) {\r\n        var r, g, b;\r\n\r\n        if(s == 0){\r\n            r = g = b = l; // achromatic\r\n        } else {\r\n            var hue2rgb = function hue2rgb(p, q, t){\r\n                if(t < 0) t += 1;\r\n                if(t > 1) t -= 1;\r\n                if(t < 1/6) return p + (q - p) * 6 * t;\r\n                if(t < 1/2) return q;\r\n                if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;\r\n                return p;\r\n            };\r\n\r\n            var q = l < 0.5 ? l * (1 + s) : l + s - l * s;\r\n            var p = 2 * l - q;\r\n            r = hue2rgb(p, q, h + 1/3);\r\n            g = hue2rgb(p, q, h);\r\n            b = hue2rgb(p, q, h - 1/3);\r\n        }\r\n\r\n        return {r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255)};\r\n    }\r\n\r\n    static CssNamedColorToHex(color: any) { // TODO put a somewhat complete list here..\r\n        if(color === 'red') {\r\n            return '#ff0000';\r\n        }\r\n        if(color === 'steelblue') {\r\n            return '#4682b4';\r\n        }\r\n        if(color === 'black') {\r\n            return '#000000';\r\n        }\r\n        //TODO add more colors.\r\n        return color;\r\n    }\r\n}","import SSVG from \"./ssvg\";\r\n\r\nexport = SSVG;","import {VdomManager, VdomNode} from \"../util/vdomManager\";\r\nimport {CanvasWorkerMessage, CanvasUpdateWorkerMessage, CanvasUpdateData} from \"../util/canvas-worker-message\"\r\nimport Domhandler from \"./domhandler\";\r\nimport CanvasWorker from \"../canvasworker/canvasworker\";\r\nimport Canvasrenderer from \"../canvasworker/canvasrenderer\";\r\nimport DrawingUtils from \"../canvasworker/drawingUtils\";\r\nimport CanvasWorkerImporter from '../canvasworker';\r\n\r\nexport default class SSVG {\r\n    private unassignedNodes: Node[] = [];\r\n    private worker: Worker;\r\n    private domHandler: Domhandler;\r\n    private vdom: VdomManager;\r\n    private interactionSelections: HTMLElement[] = [];\r\n    \r\n    private renderer: CanvasWorker;\r\n\r\n    private svg: SVGElement|undefined;\r\n    private readonly canvas: HTMLCanvasElement;\r\n    private svgAssignedAndSizeSet = false;\r\n    \r\n    private lastTenCanvasDrawTimes: number[] = [];\r\n    \r\n    private enterExitQueue: CanvasUpdateData[] = [];\r\n\r\n    private readonly safeMode: boolean = false;\r\n    private readonly maxPixelRatio: number|undefined;\r\n    private readonly useWorker: boolean = true;\r\n    private readonly getFps: (fps: number) => void = () => {};\r\n    private readonly onDrawn: () => void = () => {};\r\n\r\n    private hoveredElement: Element|undefined;\r\n\r\n    constructor(options?: {\r\n        safeMode?: boolean,\r\n        maxPixelRatio?: number,\r\n        useWorker?: boolean,\r\n        getFps?: (fps: number) => void,\r\n        onDrawn?: () => void\r\n    }) {\r\n        if(options) {\r\n            if(options.safeMode !== undefined) {\r\n                this.safeMode = options.safeMode;\r\n            }\r\n            this.maxPixelRatio = options.maxPixelRatio;\r\n            if(options.useWorker !== undefined) {\r\n                this.useWorker = options.useWorker;\r\n            }\r\n            if(options.getFps !== undefined) {\r\n                this.getFps = options.getFps;\r\n            }\r\n            if(options.onDrawn !== undefined) {\r\n                this.onDrawn = options.onDrawn;\r\n            }\r\n        }\r\n\r\n        this.canvas = document.createElement('canvas');\r\n        if(!('OffscreenCanvas' in window)) {\r\n            this.useWorker = false;\r\n        }\r\n        \r\n        if(this.useWorker) {\r\n            this.worker = new CanvasWorkerImporter();\r\n    \r\n            this.worker.onmessage = e => {\r\n                if(e.data && e.data.msg && e.data.msg === 'DRAWN') {\r\n                    this.logDrawn();\r\n                    this.updateCanvas();\r\n                }\r\n            };\r\n            const raf = () => {\r\n                this.updateFps();\r\n                requestAnimationFrame(raf);\r\n            };\r\n            raf();\r\n        } else {\r\n            const raf = () => {\r\n                this.updateFps();\r\n                this.updateCanvas();\r\n                requestAnimationFrame(raf);\r\n            };\r\n            raf();\r\n        }\r\n\r\n        this.captureD3On();\r\n        this.setupElementsIfSvgExists();\r\n        \r\n        this.canvas.addEventListener('mousedown', e => this.propagateMouseEvent(e));\r\n        this.canvas.addEventListener('mousemove', e => {\r\n            const lastHovered = this.hoveredElement;\r\n            this.hoveredElement = this.propagateMouseEvent(e);\r\n            if(lastHovered !== this.hoveredElement) {\r\n                if(lastHovered) {\r\n                    lastHovered.dispatchEvent(new MouseEvent('mouseout', e));\r\n                }\r\n            }\r\n            this.propagateMouseEvent(e, 'mouseover');\r\n        });\r\n        this.canvas.addEventListener('mouseup', e => this.propagateMouseEvent(e));\r\n        this.canvas.addEventListener('click', e => this.propagateMouseEvent(e));\r\n        this.canvas.addEventListener('wheel', e => this.propagateWheelEvent(e));\r\n\r\n        this.replaceNativeRemoveChild();\r\n        this.replaceNativeAttribute();\r\n        this.replaceNativePathFunctions();\r\n        this.replaceNativeCreateElement();\r\n        this.replaceNativeAppendChild();\r\n        this.replaceD3Attr();\r\n        this.replaceNativeSelect();\r\n        this.replaceNativeGetComputedStyle();\r\n        this.replaceD3Select();\r\n        this.replaceD3Remove();\r\n\r\n        setTimeout(() => {\r\n            console.log(this.vdom.data);\r\n        }, 1000);\r\n    }\r\n    \r\n    private setupElementsIfSvgExists(svgEl?: SVGElement) {\r\n        \r\n        if(this.svg) {\r\n            return true;\r\n        }\r\n        \r\n        const svg = !svgEl ? document.getElementsByTagName('svg')[0] : svgEl;\r\n        \r\n        if(!svg) {\r\n            return false;\r\n        }\r\n\r\n        const urlConnector = document.location.href.indexOf('?') === -1 ? '?' : '&';\r\n        const svgSwitchUrl = document.location.href + urlConnector + 'svg';\r\n        const svgSwitchComment = document.createComment(' This project uses SSVG.io to render a SVG as Canvas.\\r\\n' +\r\n            'To inspect the SVG, please open the following URL:\\r\\n' +\r\n            svgSwitchUrl + '\\r\\n');\r\n        \r\n        this.svg = svg;\r\n        this.svg.parentElement.appendChild(svgSwitchComment);\r\n        this.svg.parentElement.appendChild(this.canvas);\r\n        this.domHandler = new Domhandler(this.svg, this.useWorker, this.useWorker);\r\n        this.vdom = this.domHandler.getVDom();\r\n\r\n        this.setCanvasSize();\r\n        \r\n        return true;\r\n    }\r\n    \r\n    private updateCanvas() {\r\n        if(!this.svgAssignedAndSizeSet) {\r\n            return;\r\n        }\r\n        if(this.useWorker) {\r\n            this.domHandler.useAttrQueue(queue => {\r\n                if(Object.keys(queue).length === 0) {\r\n                    //requestAnimationFrame(() => this.updateCanvas());\r\n                    setTimeout(() => this.updateCanvas(), 1);\r\n                    return;\r\n                }\r\n                this.sendUpdateToWorker(queue);\r\n            });\r\n        } else {\r\n            this.domHandler.useAttrQueue(queue => {\r\n                if(this.renderer.updatePropertiesFromQueue) {\r\n                    this.renderer.updatePropertiesFromQueue(queue);\r\n                }\r\n\r\n                if(Object.keys(queue).length === 0) {\r\n                    //requestAnimationFrame(() => this.updateCanvas());\r\n                    setTimeout(() => this.updateCanvas(), 1);\r\n                    return;\r\n                }\r\n                this.renderer.draw();\r\n                this.logDrawn();\r\n            });\r\n        }\r\n    }\r\n    \r\n    private setCanvasSize() {\r\n        if(!this.svg || !this.vdom.data.width || !this.vdom.data.height) {\r\n            return;\r\n        }\r\n        this.vdom.data.scale = window.devicePixelRatio;\r\n        if(this.maxPixelRatio !== undefined && this.vdom.data.scale > this.maxPixelRatio) {\r\n            this.vdom.data.scale = this.maxPixelRatio;\r\n        }\r\n    \r\n        this.canvas.style.width = this.vdom.data.width + 'px';\r\n        this.canvas.style.height = this.vdom.data.height + 'px';\r\n        this.canvas.width = this.vdom.data.width * this.vdom.data.scale;\r\n        this.canvas.height = this.vdom.data.height * this.vdom.data.scale;\r\n        \r\n        if(this.useWorker) {\r\n            const offscreen = (this.canvas as any).transferControlToOffscreen();\r\n            this.sendToWorker({cmd: 'INIT', data: {\r\n                    canvas: offscreen,\r\n                    visData: this.vdom.data,\r\n                    safeMode: this.safeMode\r\n                }\r\n            }, [offscreen]);\r\n        } else {\r\n            this.renderer = new Canvasrenderer(this.vdom, this.canvas, this.safeMode, () => {});\r\n        }\r\n        \r\n        this.svgAssignedAndSizeSet = true;\r\n    }\r\n\r\n    private isWithinSvg(element: Element) {\r\n        let isWithinSvg = false;\r\n        let parentEl = element;\r\n\r\n        while(parentEl && parentEl.parentNode) {\r\n            if(parentEl === this.svg) {\r\n                isWithinSvg = true;\r\n            }\r\n            parentEl = <Element> parentEl.parentNode;\r\n        }\r\n        return isWithinSvg;\r\n    }\r\n    \r\n    private captureD3On() {\r\n        if((window as any)['d3']) {\r\n            const d3 = (window as any)['d3'];\r\n            const originalOn = d3.selection.prototype.on;\r\n            const me = this;\r\n\r\n            d3.selection.prototype.on = function()\r\n            {\r\n                let el = this._parents && this._parents.length ? this._parents[0] : this[0].parentNode;\r\n                if(el === document.children[0]) {\r\n                    el = me.svg;\r\n                }\r\n                let isWithinSvg = me.isWithinSvg(el);\r\n\r\n                if(el && isWithinSvg && me.interactionSelections.indexOf(el) === -1)\r\n                {\r\n                    me.interactionSelections.push(el); // This one works for native get/setAttribute\r\n                    //interactionSelections.push(this); // This one works for d3 .attr.\r\n                }\r\n        \r\n                return originalOn.apply(this, arguments);\r\n            };\r\n        }\r\n    }\r\n    \r\n    private replaceD3Select() {\r\n        if((window as any)['d3']) {\r\n            const me = this;\r\n            const d3 = (window as any)['d3'];\r\n\r\n            const getReplacement = (original) => {\r\n                return function(selector: string|(()=>{})) {\r\n                    if(typeof selector === 'string') {\r\n\r\n                        let element: HTMLElement|SVGElement;\r\n                        if(this === d3) {\r\n                            element = me.svg;\r\n                        } else {\r\n                            element = this._groups ? this._groups[0][0] : this[0][0];\r\n                        }\r\n\r\n                        if(!element) {\r\n                            console.error('no element', this, selector);\r\n                            return original.apply(this, arguments);\r\n                        }\r\n                        const node = me.domHandler.getVisNode(element);\r\n\r\n                        if(!node) {\r\n                            console.warn('node not found', element);\r\n                            return original.apply(this, arguments);\r\n                        }\r\n\r\n                        const childNodes = me.vdom.getVisNodesFromSelector(node, selector);\r\n                        const childElements = childNodes.map(node => {\r\n                            return me.domHandler.getElementFromNode(node);\r\n                        });\r\n\r\n                        const returnValue = original.apply(this, arguments);\r\n                        const elementsOutsideSvg: NodeList = returnValue._groups ? returnValue._groups[0]\r\n                            : returnValue[0];\r\n                        elementsOutsideSvg.forEach(childNode => {\r\n                            const childEl = <Element> <any> childNode;\r\n                            if(childElements.indexOf(childEl) === -1) {\r\n                                childElements.push();\r\n                            }\r\n                        });\r\n\r\n                        if(returnValue._groups) {\r\n                            returnValue._groups[0] = childElements;\r\n                        } else {\r\n                            // Older d3 versions\r\n                            const parentNode = returnValue[0].parentNode;\r\n                            returnValue[0] = childElements;\r\n                            returnValue[0].parentNode = parentNode;\r\n                        }\r\n\r\n                        return returnValue;\r\n                    }\r\n\r\n                    return original.apply(this, arguments);\r\n                }\r\n            };\r\n\r\n            d3.selection.prototype.selectAll = getReplacement(d3.selection.prototype.selectAll);\r\n            d3.selectAll = getReplacement(d3.selectAll);\r\n            d3.selection.prototype.select = getReplacement(d3.selection.prototype.select);\r\n            d3.select = getReplacement(d3.select);\r\n\r\n            const origFilter = d3.selection.prototype.filter;\r\n            d3.selection.prototype.filter = function(selectorString: string) {\r\n                const elements = this._groups ? this._groups[0] : this[0];\r\n                if(typeof selectorString !== 'string') {\r\n                    return origFilter.apply(this, arguments);\r\n                }\r\n                let firstElement = elements[0];\r\n                let i = 1;\r\n                while(!firstElement && i < elements.length) {\r\n                    i++;\r\n                    firstElement = elements[i];\r\n                }\r\n\r\n                const parentNode = firstElement ? me.domHandler.getNodeFromElement(firstElement.parentNode) : null;\r\n                const nodes = elements.map(element => me.domHandler.getNodeFromElement(element));\r\n\r\n                const selectors = selectorString.split(',').map(sel => sel.trim());\r\n                const filteredNodes = [];\r\n\r\n                for(const selector of selectors) {\r\n                    const matchingNodes = me.vdom.filterNodesBySelector(parentNode, nodes, selector);\r\n\r\n                    for(const node of matchingNodes) {\r\n                        if(filteredNodes.indexOf(node) === -1) {\r\n                            filteredNodes.push(node);\r\n                        }\r\n                    }\r\n                }\r\n\r\n                const filteredElements = filteredNodes.map(node => me.domHandler.getElementFromNode(node));\r\n\r\n                const returnValue = origFilter.apply(this, arguments);\r\n\r\n                if(returnValue._groups) {\r\n                    returnValue._groups[0] = filteredElements;\r\n                } else {\r\n                    // Older d3 versions\r\n                    const parentNode = returnValue[0].parentNode;\r\n                    returnValue[0] = filteredElements;\r\n                    returnValue[0].parentNode = parentNode;\r\n                }\r\n                return returnValue;\r\n            }\r\n        }\r\n    }\r\n\r\n    private replaceNativeGetComputedStyle() {\r\n        const origGetComputedStyle = window.getComputedStyle;\r\n        const me = this;\r\n\r\n        window.getComputedStyle = function(element: HTMLElement) {\r\n            if(element && !me.isWithinSvg(element) && (<Window> <any> element) !== window) {\r\n                return origGetComputedStyle.call(this, element);\r\n            }\r\n\r\n            const node = me.domHandler.getNodeFromElement(element);\r\n            if(!node) {\r\n                console.warn('node not found for ', this, element);\r\n                return origGetComputedStyle.call(this, element);\r\n            }\r\n            return {\r\n                getPropertyValue(propertyName: string): string {\r\n                    //console.log(propertyName, node, node.style[propertyName]);\r\n                    return node.style[propertyName];\r\n                }\r\n            } as CSSStyleDeclaration;\r\n        };\r\n    }\r\n\r\n    private replaceNativeSelect() {\r\n        const origQuerySelector = Element.prototype.querySelector;\r\n        const me = this;\r\n\r\n        Element.prototype.querySelector = function(selector: string) {\r\n            if(!me.isWithinSvg(this)) {\r\n                return origQuerySelector.apply(this, arguments);\r\n            }\r\n\r\n            const node = me.domHandler.getVisNode(this);\r\n            const childNodes = me.vdom.getVisNodesFromSelector(node, selector);\r\n            if(childNodes.length === 0) {\r\n                console.warn('could not find selection', this, node, node.globalElementIndex, selector);\r\n                return null;\r\n            }\r\n            return me.domHandler.getElementFromNode(childNodes[0]);\r\n        };\r\n    }\r\n    \r\n    private replaceD3Attr() {\r\n\r\n        const me = this;\r\n\r\n        function getReplacement(originalFct, prefix = '') {\r\n            return function(name, value) {\r\n                \r\n                if(value === undefined) {\r\n\r\n                    if(me.unassignedNodes.indexOf(this) !== -1) {\r\n                        return originalFct.apply(this, arguments);\r\n                    } else {\r\n                        // Dealing with d3 v3.\r\n                        const els = this._groups ? this._groups[0] : this[0];\r\n                        if(els[0] && !me.isWithinSvg(els[0])) {\r\n                            return originalFct.apply(this, arguments);\r\n                        }\r\n                        if(els.length > 1) {\r\n                            const returnVal = [];\r\n                            for(const el of els) {\r\n                                returnVal.push(me.domHandler.getAttributeFromSelector(el, name))\r\n                            }\r\n                            return returnVal;\r\n                        } else {\r\n                            return me.domHandler.getAttributeFromSelector(els[0], name);\r\n                        }\r\n                    }\r\n                } else {\r\n                    if(name === 'class' || !me.svg) {\r\n                        return originalFct.apply(this, arguments);\r\n                    }\r\n                    // For d3 v4, this would just be this.groups[0]. The rest is for\r\n                    // earlier versions, where selectAll() returned other values.\r\n                    let elements = this._groups ? this._groups[0] : this[0];\r\n\r\n                    if(typeof elements === 'object' && Object.keys(elements).length === 1 && elements.parentNode) {\r\n                        const parentElement = elements.parentNode;\r\n                        let parentNode: VdomNode;\r\n                        if(parentElement !== document.children[0]) {\r\n                            const selector = me.domHandler.getElementSelector(parentElement);\r\n                            if(selector === null) {\r\n                                console.error('selector not found', parentElement, elements);\r\n                                throw Error('selector not found');\r\n                            }\r\n                            parentNode = me.vdom.getVisNodeFromSelector(selector);\r\n                        } else {\r\n                            parentNode = me.vdom.data;\r\n                        }\r\n\r\n                        elements = [];\r\n                        for(const child of parentNode.children) {\r\n                            elements.push(me.domHandler.getElementFromNode(child));\r\n                        }\r\n                    }\r\n                    if(!elements) {\r\n                        return originalFct.apply(this, arguments);\r\n                    }\r\n                    const filteredElements = [];\r\n                    try {\r\n                        for (const element of elements) {\r\n                            if (element) {\r\n                                filteredElements.push(element);\r\n                            }\r\n                        }\r\n                    } catch(e) {\r\n                        console.error(elements, this);\r\n                        console.error(e);\r\n                    }\r\n                    if(filteredElements.length === 1) {\r\n                        const element = filteredElements[0];\r\n                        if(!element) {\r\n                            console.warn('element not found', this, name, value);\r\n                            return this;\r\n                        }\r\n                        if(!me.isWithinSvg(element)) {\r\n                            return originalFct.apply(this, arguments);\r\n                        }\r\n                        me.domHandler.queueSetAttributeOnElement(element, prefix + name, value);\r\n                    } else {\r\n                        if(!me.isWithinSvg(elements[0])) {\r\n                            return originalFct.apply(this, arguments);\r\n                        }\r\n                        me.domHandler.queueSetAttributeOnSelection(filteredElements, prefix + name, value);\r\n                    }\r\n                    \r\n                    if(filteredElements[0] === me.svg && (name === 'width' || name === 'height')) {\r\n                        me.vdom.data[name] = parseInt(value);\r\n                        me.setCanvasSize();\r\n                    }\r\n                \r\n                    return this;\r\n                }\r\n            };\r\n        }\r\n    \r\n        if((window as any)['d3']) {\r\n            const d3 = (window as any)['d3'];\r\n\r\n            const origSelectionAttr = d3.selection.prototype.attr;\r\n            d3.selection.prototype.attr = getReplacement(origSelectionAttr);\r\n\r\n            const origSelectionStyle = d3.selection.prototype.style;\r\n            d3.selection.prototype.style = getReplacement(origSelectionStyle, 'style;');\r\n\r\n            const originalClassed = d3.selection.prototype.classed;\r\n            d3.selection.prototype.classed = function(className: string,\r\n                                                      value?: boolean|((data: any, index: number) => boolean)) {\r\n                if(value !== undefined) {\r\n                    me.domHandler.enableFrontendDesignProperties();\r\n                    let elements = this._groups ? this._groups[0] : this[0];\r\n                    let i = 0;\r\n                    for(let element of elements) {\r\n                        if(element) {\r\n                            const indexOfParent = element.childIndex;\r\n                            const parentSelector = element['parentSelector'];\r\n                            const parent = me.vdom.getParentNodeFromSelector(parentSelector);\r\n                            const node = parent.children[indexOfParent];\r\n                            if(!node) {\r\n                                console.warn('node not found', element, parent, indexOfParent, className);\r\n                                continue;\r\n                            }\r\n                            const prevClassNames = node.className || '';\r\n                            const evaluatedValue = typeof value === \"function\" ? value((<any> element).__data__, i) : value;\r\n                            if(evaluatedValue === true) {\r\n                                if(prevClassNames.indexOf(className) === -1) {\r\n                                    let newClassNames = (prevClassNames + ' ' + className).trim();\r\n\r\n                                    me.domHandler.queueSetAttributeOnElement(element, 'class', newClassNames);\r\n                                }\r\n                            } else if(evaluatedValue === false) {\r\n                                const containedPreviously = prevClassNames.indexOf(className) !== -1;\r\n                                if(containedPreviously) {\r\n                                    const newClassNames = prevClassNames.replace(className, '').replace('  ', ' ');\r\n                                    me.domHandler.queueSetAttributeOnElement(element, 'class', newClassNames);\r\n\r\n                                    node['removedClass'] = className; // For removing associated styles.\r\n                                }\r\n                            }\r\n                        }\r\n\r\n                        i++;\r\n                    }\r\n                }\r\n                return originalClassed.apply(this, arguments);\r\n            };\r\n\r\n            const originalTransition = d3.selection.prototype.transition;\r\n            d3.selection.prototype.transition = function() {\r\n                me.domHandler.enableFrontendDesignProperties();\r\n                return originalTransition.apply(this, arguments);\r\n            };\r\n\r\n            const originalText = d3.selection.prototype.text;\r\n            d3.selection.prototype.text = function(value?: boolean|((data: any, index: number) => boolean)) {\r\n                if(value !== undefined) {\r\n                    let elements = this._groups ? this._groups[0] : this[0];\r\n                    let i = 0;\r\n                    for(let element of elements) {\r\n                        if(element && me.isWithinSvg(element)) {\r\n                            const evaluatedValue = typeof value === \"function\" ? value((<any> element).__data__, i) : value;\r\n                            me.domHandler.queueSetAttributeOnElement(element, 'text', evaluatedValue);\r\n                        }\r\n\r\n                        i++;\r\n                    }\r\n                }\r\n                return originalText.apply(this, arguments);\r\n            };\r\n        }\r\n    }\r\n\r\n    private replaceD3Remove() {\r\n        if(window['d3']) {\r\n            const d3 = window['d3'];\r\n            const me = this;\r\n\r\n            const newRemove = this.getNewRemoveChild(() => {}, true);\r\n            const d3Remove = function() {\r\n                let elements = this._groups ? this._groups[0] : this[0];\r\n\r\n                if(elements.length) {\r\n                    let parentElement: HTMLElement = null;\r\n                    for(let i = elements.length - 1; i > -1; i--) {\r\n                        const element = elements[i];\r\n                        if(element) {\r\n                            parentElement = element.parentNode;\r\n                            if(!parentElement) {\r\n                                console.error('element has no parent node', element);\r\n                            }\r\n                            newRemove.call(parentElement, element);\r\n                        }\r\n\r\n                    }\r\n                    if(parentElement) {\r\n                        me.updateChildSelectors(parentElement);\r\n                    }\r\n                }\r\n                return this;\r\n            };\r\n            d3.selection.prototype.remove = d3Remove;\r\n            //d3.transition.prototype.remove = d3Remove;\r\n        }\r\n    }\r\n    \r\n    private replaceNativeCreateElement() {\r\n        const origCreate = document.createElementNS;\r\n        const me = this;\r\n        \r\n        document.createElementNS = function() {\r\n            let newArgs = Array.from(arguments);\r\n            const el = origCreate.apply(this, newArgs);\r\n            \r\n            /*el.appendChild = () => {\r\n                console.log('hi!!', el, arguments);\r\n                //return el;\r\n            };*/\r\n    \r\n            el.appendChild = me.getNewAppendChild(el.appendChild);\r\n            \r\n            me.unassignedNodes.push(el);\r\n    \r\n            //console.log(me.unassignedNodes);\r\n            \r\n            return el;\r\n        }\r\n    }\r\n\r\n    private updateChildSelectors(parentElement: Element, parentNode?: VdomNode) {\r\n        const parentSelector = parentElement['selector'];\r\n        if(!parentSelector) {\r\n            console.error('this node has no selector', parentElement)\r\n        }\r\n        if(!parentNode) {\r\n            parentNode = this.vdom.getParentNodeFromSelector(parentSelector);\r\n        }\r\n        for(let i = 0; i < parentNode.children.length; i++) {\r\n            const childNode: VdomNode = parentNode.children[i];\r\n            const childElement = this.domHandler.getElementFromNode(childNode);\r\n            if(!childElement) {\r\n                console.error('element not found', childNode, parentNode.children.length, i);\r\n                continue;\r\n            }\r\n            const oldSelector = childElement['selector'];\r\n\r\n            childElement['childIndex'] = i;\r\n            childElement['parentSelector'] = parentSelector;\r\n            childElement['selector'] = this.domHandler.combineElementSelectors(parentSelector, childNode.type, i+1);\r\n\r\n            this.domHandler.updateNodeSelector(oldSelector, childElement['selector']);\r\n\r\n            this.updateChildSelectors(childElement, childNode);\r\n        }\r\n    }\r\n\r\n    private getNewRemoveChild(origRemoveChild: ((<T extends Node>(oldChild: T) => T)|(() => void)),\r\n        skipUpdateSelectors = false) {\r\n        const me = this;\r\n\r\n        return function<T extends Node>(this: Element, el: T) {\r\n            if(!this) {\r\n                console.error('context not defined');\r\n                return el;\r\n            }\r\n            if(!me.isWithinSvg(<Element> <any> el)) {\r\n                return origRemoveChild.apply(this, arguments);\r\n            }\r\n            const parentNode = me.domHandler.getNodeFromElement(<Element> <any> this);\r\n            const parentSelector = this['selector'];\r\n            const node = me.domHandler.getNodeFromElement(<Element> <any> el);\r\n\r\n            if(!node) {\r\n                console.error('node not found', node, el, this, parentNode);\r\n                return origRemoveChild.apply(this, arguments);\r\n            }\r\n\r\n            // Remove all child elements.\r\n            for(const childNode of node.children) {\r\n                const childEl = me.domHandler.getElementFromNode(childNode);\r\n                el.removeChild(childEl);\r\n            }\r\n\r\n            // Remove from current parent first.\r\n            Object.defineProperty(el, 'parentNode', {\r\n                writable: true,\r\n                value: undefined\r\n            });\r\n\r\n            //console.log('remove')\r\n            me.enterExitQueue.push({\r\n                cmd: 'EXIT',\r\n                childIndex: el['childIndex'],\r\n                parentNodeSelector: parentSelector\r\n            });\r\n\r\n            me.domHandler.removeNodeFromParent(<Element> <any> el, node);\r\n\r\n            // Fix child indices of all children.\r\n            if(!skipUpdateSelectors) {\r\n                if(!parentSelector) {\r\n                    console.error('parent not found', parentNode, parentSelector, this, el);\r\n                }\r\n                me.updateChildSelectors(this);\r\n            }\r\n\r\n            delete el['selector'];\r\n\r\n            return el;\r\n        };\r\n    }\r\n\r\n    private replaceNativeRemoveChild() {\r\n        Element.prototype.removeChild = this.getNewRemoveChild(Element.prototype.removeChild);\r\n    }\r\n    \r\n    private getNewAppendChild(origAppend) {\r\n        const me = this;\r\n        \r\n        return function<T extends Node>(this: Element, el: T) {\r\n            if(!me.svgAssignedAndSizeSet) {\r\n                if(!me.svg && el['tagName'] === 'svg') {\r\n                    const appended = origAppend.apply(this, arguments);\r\n                    me.setupElementsIfSvgExists(<SVGElement> <any> el);\r\n                    return appended;\r\n                    \r\n                } else {\r\n                    return origAppend.apply(this, arguments);\r\n                }\r\n            }\r\n            \r\n            if(!me.isWithinSvg(this)) {\r\n                return origAppend.apply(this, arguments);\r\n            }\r\n\r\n            Object.defineProperty(el, 'ownerSVGElement', {\r\n                writable: true,\r\n                value: me.svg\r\n            });\r\n            el['appendChild'] = <T extends Node>(el2: T) => {\r\n                return me.getNewAppendChild(origAppend).call(el, el2);\r\n            };\r\n            const parentSelector = me.domHandler.getElementSelector(this);\r\n            if(parentSelector === null) {\r\n                return origAppend.apply(this, arguments);\r\n            }\r\n\r\n            const parentNode = me.domHandler.getNodeFromElement(this);\r\n            if(!parentNode) {\r\n                return console.error('parent node not found', parentSelector, this);\r\n            }\r\n            let node: VdomNode;\r\n            let keepChildren = false;\r\n\r\n            if(el['parentSelector']) {\r\n                node = me.domHandler.getVisNode(<Element> <any> el);\r\n\r\n                me.getNewRemoveChild(() => {}).call(this, el);\r\n                keepChildren = true; // If the element is being moved around, keep children.\r\n            } else {\r\n                node = me.domHandler.getNodeDataFromEl(<HTMLElement><any> el);\r\n            }\r\n\r\n            (el as any)['parentSelector'] = parentSelector;\r\n            (el as any)['selector'] = me.domHandler.getElementSelector(<Element><any> el, parentNode);\r\n            (el as any)['childIndex'] = parentNode.children.length;\r\n\r\n            Object.defineProperty(el, 'style', {\r\n                writable: true,\r\n                value: {\r\n                    setProperty: function(styleProp: string, value: string) {\r\n                        me.domHandler.queueSetAttributeOnElement(el as any, 'style;' + styleProp, value);\r\n                    },\r\n                    getPropertyValue: function(styleProp) {\r\n                        me.domHandler.enableFrontendDesignProperties();\r\n                        return node.style[styleProp];\r\n                    }\r\n                }\r\n            });\r\n\r\n            Object.defineProperty(el, 'parentNode', {\r\n                writable: true,\r\n                value: this\r\n            });\r\n    \r\n            me.domHandler.linkNodeToElement(node, el);\r\n            me.domHandler.addNodeToParent(parentNode, node);\r\n            me.updateChildSelectors(el as unknown as Element, node);\r\n            \r\n            if(me.useWorker) {\r\n                me.enterExitQueue.push({\r\n                    cmd: 'ENTER',\r\n                    node: node,\r\n                    parentNodeSelector: parentSelector,\r\n                    keepChildren: keepChildren\r\n                });\r\n            } else {\r\n                if(me.renderer.addNode) {\r\n                    me.renderer.addNode(node);\r\n                }\r\n            }\r\n    \r\n            if(me.unassignedNodes.indexOf(el) !== -1) {\r\n                const index = me.unassignedNodes.indexOf(el);\r\n                me.unassignedNodes.splice(index, 1);\r\n            }\r\n    \r\n            return el;\r\n        };\r\n    }\r\n    \r\n    private replaceNativeAppendChild() {\r\n        const origAppendChild = Element.prototype.appendChild;\r\n        const newAppend = this.getNewAppendChild(origAppendChild);\r\n    \r\n        Element.prototype.appendChild = newAppend;\r\n        Element.prototype.insertBefore = function<T extends Node>(newChild: T, refChild: Node|null) {\r\n    \r\n            newAppend.call(this, newChild);\r\n            \r\n            return newChild;\r\n        };\r\n    }\r\n\r\n    private replaceNativePathFunctions() {\r\n        const me = this;\r\n        //const origGetPointAtLength = SVGPathElement.prototype.getPointAtLength;\r\n        const origGetTotalLength = SVGPathElement.prototype.getTotalLength;\r\n\r\n        /*SVGPathElement.prototype.getPointAtLength = function() {\r\n            if(me.isWithinSvg(this)) {\r\n                const d = this.getAttribute('d');\r\n                me.origSetAttribute.call(this, 'd', d);\r\n            }\r\n            return origGetPointAtLength.apply(this, arguments);\r\n        };*/\r\n        SVGPathElement.prototype.getTotalLength = function() {\r\n            if(me.isWithinSvg(this)) {\r\n                const d = this.getAttribute('d');\r\n                me.origSetAttribute.call(this, 'd', d);\r\n            }\r\n\r\n            return origGetTotalLength.apply(this, arguments);\r\n        };\r\n    }\r\n\r\n    private origSetAttribute;\r\n\r\n    private replaceNativeAttribute() {\r\n        const origSetAttr = Element.prototype.setAttribute;\r\n        this.origSetAttribute = origSetAttr;\r\n        const origSetAttrNS = Element.prototype.setAttributeNS;\r\n        const origGetAttr = Element.prototype.getAttribute;\r\n        const me = this;\r\n    \r\n        Element.prototype.setAttribute = function(name: string, value: any) {\r\n            if(name === 'easypz' || me.unassignedNodes.indexOf(this) !== -1) {\r\n                // Update the original SVG\r\n                origSetAttr.apply(this, arguments);\r\n                return;\r\n            }\r\n            if(name === 'class') {\r\n                origSetAttr.apply(this, arguments);\r\n            }\r\n            if(!me.isWithinSvg(this)) {\r\n                return origSetAttr.apply(this, arguments);\r\n            }\r\n            me.domHandler.queueSetAttributeOnElement(this, name, value);\r\n        };\r\n        //TODO: Figure out how to access the element when setting a style property.\r\n        /*CSSStyleDeclaration.prototype.setProperty = function(name: string, value: any) {\r\n            safeLog(this, arguments);\r\n            me.elementHandler.queueSetAttributeOnElement(this, 'style;' + name, value);\r\n        };*/\r\n        Element.prototype.setAttributeNS = function(name: string, value: any) {\r\n            if(name === 'easypz' || me.unassignedNodes.indexOf(this) !== -1) {\r\n                // Update the original SVG\r\n                origSetAttrNS.apply(this, arguments);\r\n                return;\r\n            }\r\n            if(name === 'class') {\r\n                origSetAttrNS.apply(this, arguments);\r\n            }\r\n            if(!me.isWithinSvg(this)) {\r\n                return origSetAttrNS.apply(this, arguments);\r\n            }\r\n            me.domHandler.queueSetAttributeOnElement(this, name, value);\r\n        };\r\n    \r\n        Element.prototype.getAttribute = function(name) {\r\n            if(me.unassignedNodes.indexOf(this) !== -1) {\r\n                return origGetAttr.apply(this, arguments);\r\n            } else {\r\n                try {\r\n                    return me.domHandler.getAttributeFromSelector(this, name);\r\n                } catch(e) {\r\n                    console.error(e);\r\n                    return origGetAttr.apply(this, arguments);\r\n                }\r\n            }\r\n        };\r\n    }\r\n    \r\n    private propagateMouseEvent(evt: MouseEvent, type?: string) {\r\n        return this.propagateEvent(new MouseEvent(type? type : evt.type, evt));\r\n    }\r\n    \r\n    private propagateWheelEvent(evt: WheelEvent) {\r\n        return this.propagateEvent(new WheelEvent(evt.type, evt));\r\n    }\r\n    \r\n    private propagateEvent(new_event: MouseEvent|WheelEvent): undefined|Element {\r\n        this.svg.dispatchEvent(new_event); // for EasyPZ\r\n\r\n        let triggeredElement: undefined|Element;\r\n\r\n        for(let interactionSel of this.interactionSelections)\r\n        {\r\n            let parentSelector = this.domHandler.getElementSelector(interactionSel);\r\n            let parentNode = this.vdom.getVisNodeFromSelector(parentSelector);\r\n            \r\n            //let matchingVisParent = selectedNodes[i];\r\n            let j = 1;\r\n            \r\n            if(!parentNode) {\r\n                //console.error(interactionSel, parentSelector, parentNode);\r\n            } else {\r\n                for(let vdomNode of parentNode.children)\r\n                {\r\n                    let childNode = this.nodeAtPosition(vdomNode, new_event.clientX-10, new_event.clientY-10);\r\n                    if(childNode)\r\n                    {\r\n                        /*let selector = parentSelector + ' > :nth-child(' + j + ')';\r\n                        let svgEl = this.svg.querySelector(selector);*/\r\n                        const svgEl = this.domHandler.getElementFromNode(vdomNode);\r\n                        const svgChildEl = this.domHandler.getElementFromNode(childNode);\r\n\r\n                        if(svgChildEl) {\r\n                            Object.defineProperty(new_event, 'target', {\r\n                                writable: true,\r\n                                value: svgChildEl\r\n                            });\r\n                        }\r\n\r\n                        if(svgChildEl) {\r\n                            triggeredElement = svgChildEl;\r\n                            svgChildEl.dispatchEvent(new_event);\r\n                        }\r\n\r\n                        if(svgEl) {\r\n                            if(!triggeredElement) {\r\n                                triggeredElement = svgEl;\r\n                                svgEl.dispatchEvent(new_event);\r\n                            }\r\n                        }\r\n                    }\r\n                    j++;\r\n                }\r\n            }\r\n        }\r\n        return triggeredElement;\r\n    }\r\n    \r\n    private nodeAtPosition(visNode: VdomNode, x: number, y: number): false|VdomNode {\r\n        if (visNode.type === 'circle') {\r\n            let cx = visNode.cx || 0;\r\n            let cy = visNode.cy || 0;\r\n            if (visNode.transform) {\r\n                const transform = DrawingUtils.parseTransform(visNode.transform);\r\n                if (transform.translateX) {\r\n                    cx += transform.translateX;\r\n                }\r\n                if (transform.translateY) {\r\n                    cy += transform.translateY;\r\n                }\r\n            }\r\n            const distance = Math.sqrt(Math.pow(cx - x, 2) + Math.pow(cy - y, 2));\r\n            return distance < visNode.r ? visNode : false;\r\n        } else if(visNode.type === 'rect') {\r\n\r\n            let elX = visNode.x || 0;\r\n            let elY = visNode.y || 0;\r\n            const width = visNode.width;\r\n            const height = visNode.height;\r\n\r\n            if (visNode.transform) {\r\n                const transform = DrawingUtils.parseTransform(visNode.transform);\r\n                if (transform.translateX) {\r\n                    elX += transform.translateX;\r\n                }\r\n                if (transform.translateY) {\r\n                    elY += transform.translateY;\r\n                }\r\n            }\r\n\r\n            const centerX = elX + width / 2;\r\n            const centerY = elY + height / 2;\r\n\r\n            const distanceX = Math.abs(centerX - x);\r\n            const distanceY = Math.abs(centerY - y);\r\n\r\n            return distanceX < width / 2 && distanceY < height / 2 ? visNode : false;\r\n\r\n        } else if(visNode.type === 'g') {\r\n\r\n            const transform = this.domHandler.getTotalTransformation(visNode);\r\n            if(transform.translateX) {\r\n                x -= transform.translateX;\r\n            }\r\n            if(transform.translateY) {\r\n                y -= transform.translateY;\r\n            }\r\n\r\n            let matchAny: false|VdomNode = false;\r\n            for(let i = 0; i < visNode.children.length; i++) {\r\n                if(this.nodeAtPosition(visNode.children[i], x, y)) {\r\n                    matchAny = visNode.children[i];\r\n                }\r\n            }\r\n            return matchAny;\r\n        }\r\n        return false;\r\n    }\r\n    \r\n    private logDrawn() {\r\n        this.lastTenCanvasDrawTimes.push(Date.now());\r\n        \r\n        if(this.lastTenCanvasDrawTimes.length > 100) {\r\n            this.lastTenCanvasDrawTimes.shift(); // Remove first item\r\n        }\r\n        this.onDrawn();\r\n    }\r\n    \r\n    private updateFps() {\r\n        if(this.lastTenCanvasDrawTimes.length) {\r\n            const timeForTenDrawsMs = Date.now() - this.lastTenCanvasDrawTimes[0];\r\n            const fps = Math.round(this.lastTenCanvasDrawTimes.length / timeForTenDrawsMs * 1000);\r\n            this.getFps(fps);\r\n        }\r\n    }\r\n\r\n    private sendUpdateToWorker(queue) {\r\n        const msg: CanvasUpdateWorkerMessage = {\r\n            cmd: 'UPDATE_NODES',\r\n            data: {\r\n                enterExit: this.enterExitQueue,\r\n                update: queue,\r\n            }\r\n        };\r\n\r\n        this.sendToWorker(msg);\r\n\r\n        this.enterExitQueue = [];\r\n    }\r\n\r\n    private sendToWorker(msg: CanvasWorkerMessage, data?: any) {\r\n        this.worker.postMessage(msg, data);\r\n        //console.log(roughSizeOfObject(msg));\r\n    }\r\n}\r\n\r\n\r\nlet safeLogCount = 0;\r\nfunction safeLog(...logContents) {\r\n    \r\n    if(safeLogCount < 50) {\r\n        safeLogCount++;\r\n        console.log(...logContents);\r\n    }\r\n}\r\nfunction safeErrorLog(...logContents) {\r\n    \r\n    if(safeLogCount < 50) {\r\n        safeLogCount++;\r\n        console.error(...logContents);\r\n    }\r\n}","import {VdomManager, VdomNode, VdomNodeType} from \"../util/vdomManager\";\r\nimport DrawingUtils, {Transformation} from \"../canvasworker/drawingUtils\";\r\nimport drawingUtils from \"../canvasworker/drawingUtils\";\r\n\r\nexport default class Domhandler {\r\n    \r\n    private vdom: VdomManager;\r\n    private sharedArrays: {[parentSelector: string]: { [attrName: string]: Int32Array}} = {};\r\n    private setAttrQueue: {[parentSelector: string]: { [attrName: string]: (string[]|SharedArrayBuffer)}} = {};\r\n    private nodesToElements: { nodes: VdomNode[], elements: Element[]} = { nodes: [], elements: []};\r\n    private nodesToRestyle: VdomNode[] = [];\r\n    \r\n    constructor(private svg: SVGElement, useWorker: boolean, private ignoreDesign = true) {\r\n        const visData: any = {\r\n            width: this.svg.getAttribute('width'),\r\n            height: this.svg.getAttribute('height'),\r\n            scale: 1,\r\n            children: []\r\n        };\r\n\r\n        this.vdom = new VdomManager(visData, ignoreDesign);\r\n        this.svg.style.display = 'none';\r\n        this.svg['selector'] = 'svg';\r\n\r\n        this.addChildNodesToVisData(this.svg.childNodes, this.vdom.data);\r\n\r\n        window.setTimeout(() => {\r\n            // Re-do the styles.\r\n            this.nodesToRestyle = [];\r\n            // Can not use this.nodesToRestyle = this.nodesToElements.nodes because this links the object and adding\r\n            // to this.nodesToRestyle would break the nodesToElements mapping.\r\n            for(const node of this.nodesToElements.nodes) {\r\n                this.nodesToRestyle.push(node);\r\n            }\r\n        }, 100);\r\n    }\r\n\r\n    enableFrontendDesignProperties() {\r\n        this.ignoreDesign = false;\r\n        this.vdom.enableFrontendDesignProperties();\r\n    }\r\n    \r\n    getVDom() {\r\n        return this.vdom;\r\n    }\r\n    \r\n    queueSetAttributeOnElement(element: Element, attrName: string, value: any) {\r\n        //TODO: merge with updatePropertiesFromQueue from VdomManager?\r\n        const parent = element.parentNode;\r\n        let parentSelector = parent === this.svg ? \"svg\" : (element as any)['parentSelector'] as string;\r\n        let childIndex = (element as any)['childIndex'];\r\n    \r\n        if(!parentSelector && element === this.svg) {\r\n            parentSelector = 'SVG_PARENT';\r\n            childIndex = 0;\r\n        }\r\n    \r\n        if(!parentSelector) {\r\n            safeLog(element, parent);\r\n            console.error('selector not found');\r\n            return;\r\n        }\r\n\r\n        if(element === this.svg && attrName.indexOf('style;') === 0) {\r\n            attrName = attrName.substr('style;'.length);\r\n        }\r\n        attrName = this.checkAttrName(parentSelector, attrName, false);\r\n        const evaluatedValue = typeof value === \"function\" ? value.call(<any> element, (<any> element).__data__, childIndex) : value;\r\n        this.setAttrQueue[parentSelector][attrName][childIndex] = evaluatedValue;\r\n\r\n        if(attrName === 'className' || attrName.indexOf('style') !== -1) {\r\n            // Apply classes immediately so styles can be applied correctly.\r\n            const node = this.getNodeFromElement(element);\r\n\r\n            if(attrName === 'className') {\r\n                node.className = evaluatedValue;\r\n                this.nodesToRestyle.push(node);\r\n            } else {\r\n                const styleName = attrName.substr(6);\r\n                if(!node.style) {\r\n                    console.error('no styles on node ', node);\r\n                }\r\n                node.style[styleName] = evaluatedValue;\r\n            }\r\n        }\r\n    }\r\n    \r\n    queueSetAttributeOnSelection(elements, attrName, value) {\r\n        if(!elements.length) return;\r\n        if(!elements[0]) {\r\n            //console.error('selection elements not found', elements);\r\n            return;\r\n        }\r\n        const useSharedArray = 'SharedArrayBuffer' in self;\r\n\r\n        let parentElement = elements[0].parentNode;\r\n        let parentNode = this.getNodeFromElement(parentElement);\r\n        let parentSelector = parentElement === this.svg ? \"svg\" : parentElement['selector'];\r\n        if(!parentSelector) {\r\n            safeLog(elements, parentElement);\r\n            console.error('selector not found');\r\n        }\r\n\r\n        attrName = this.checkAttrName(parentSelector, attrName, useSharedArray, parentNode);\r\n        \r\n        for(let i = 0; i < elements.length; i++) {\r\n            const svgEl = elements[i];\r\n            const indexOfParent = svgEl.childIndex;\r\n\r\n            if(svgEl.parentNode !== parentElement) {\r\n                parentElement = svgEl.parentNode;\r\n                parentNode = this.getNodeFromElement(parentElement);\r\n                parentSelector = parentElement === this.svg ? \"svg\" : parentElement['selector'];\r\n                attrName = this.checkAttrName(parentSelector, attrName, useSharedArray, parentNode);\r\n            }\r\n\r\n            const evaluatedValue = typeof value === \"function\" ? value(svgEl.__data__, i) : value;\r\n            if(this.useSharedArrayFor.indexOf(attrName) === -1 || !useSharedArray) {\r\n                this.setAttrQueue[parentSelector][attrName][indexOfParent] = evaluatedValue;\r\n            } else {\r\n                this.sharedArrays[parentSelector][attrName][indexOfParent] = evaluatedValue * 10; // For precision.\r\n            }\r\n        }\r\n\r\n        if(attrName === 'className' || attrName.indexOf('style') !== -1) {\r\n            // Apply classes immediately so styles can be applied correctly.\r\n            for(let i = 0; i < elements.length; i++) {\r\n                const node = this.getNodeFromElement(elements[i]);\r\n                const evaluatedValue = typeof value === \"function\" ? value(elements[i].__data__, i) : value;\r\n\r\n                if(attrName === 'className') {\r\n                    node.className = evaluatedValue;\r\n                    this.nodesToRestyle.push(node);\r\n                } else {\r\n                    const styleName = attrName.substr(6);\r\n                    node.style[styleName] = evaluatedValue;\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    private useSharedArrayFor = ['cx', 'cy', 'x1', 'x2', 'y1', 'y2', 'x', 'y'];\r\n    \r\n    private checkAttrName(parentSelector: string, attrName: string, useBuffer = false, parentNode?: VdomNode) {\r\n        if(attrName === 'class') {\r\n            attrName = 'className';\r\n        }\r\n\r\n        if(!this.setAttrQueue[parentSelector]) {\r\n            this.setAttrQueue[parentSelector] = {};\r\n            this.sharedArrays[parentSelector] = {};\r\n        }\r\n\r\n        if(!useBuffer || this.useSharedArrayFor.indexOf(attrName) === -1) {\r\n            if(!this.setAttrQueue[parentSelector][attrName]) {\r\n                this.setAttrQueue[parentSelector][attrName] = [];\r\n            }\r\n        } else {\r\n            if(!this.sharedArrays[parentSelector][attrName]) {\r\n                if(!parentNode) {\r\n                    parentNode = this.vdom.getParentNodeFromSelector(parentSelector)\r\n                }\r\n                const length = parentNode.children.length;\r\n                const buffer = new SharedArrayBuffer(Int32Array.BYTES_PER_ELEMENT * length);\r\n\r\n                this.setAttrQueue[parentSelector][attrName] = buffer;\r\n                this.sharedArrays[parentSelector][attrName] = new Int32Array(buffer);\r\n            }\r\n        }\r\n\r\n        return attrName;\r\n    }\r\n    \r\n    useAttrQueue(cb: (data) => void = () => {}) {\r\n        if(this.nodesToRestyle) {\r\n            this.applyStyles();\r\n        }\r\n\r\n        cb(this.setAttrQueue);\r\n        this.vdom.updatePropertiesFromQueue(this.setAttrQueue);\r\n        \r\n        this.setAttrQueue = {};\r\n    }\r\n    \r\n    getAttributesFromSelector(selection, name: string) {\r\n        // Dealing with d3 v3.\r\n        const els = selection._groups ? selection._groups[0] : selection[0];\r\n        \r\n        return els.map(el => this.getAttributeFromSelector(el, name));\r\n    }\r\n    \r\n    getAttributeFromSelector(element: Element, name: string) {\r\n        const node = this.getNodeFromElement(element);\r\n        \r\n        if(!node) {\r\n            console.error('trying to get attribute for unfit selection', node, element, name);\r\n            throw Error('element not found');\r\n        }\r\n        \r\n        return node[name];\r\n    }\r\n    \r\n    getVisNode(element: Element): VdomNode|null {\r\n        const selector = this.getElementSelector(element);\r\n\r\n        if(selector === null) {\r\n            return null;\r\n        }\r\n        \r\n        return this.vdom.getVisNodeFromSelector(selector);\r\n    }\r\n    \r\n    getNodeDataFromEl(el: HTMLElement): VdomNode {\r\n        const getRoundedAttr = (el: Element, attrName: string) => {\r\n            const val = el.getAttribute(attrName);\r\n            return val ? parseFloat(val) : null;\r\n        };\r\n        \r\n        const node = {\r\n            type: el.tagName.toLowerCase() as VdomNodeType,\r\n            transform: el.getAttribute('transform'),\r\n            d: el.getAttribute('d'),\r\n            className: el.getAttribute('class'),\r\n            id: el.getAttribute('id'),\r\n            r: getRoundedAttr(el, 'r'),\r\n            fill: el.getAttribute('fill'),\r\n            cx: getRoundedAttr(el, 'cx'),\r\n            cy: getRoundedAttr(el, 'cy'),\r\n            x: getRoundedAttr(el, 'x'),\r\n            y: getRoundedAttr(el, 'y'),\r\n            x1: getRoundedAttr(el, 'x1'),\r\n            x2: getRoundedAttr(el, 'x2'),\r\n            y1: getRoundedAttr(el, 'y1'),\r\n            y2: getRoundedAttr(el, 'y2'),\r\n            \"stroke-width\": getRoundedAttr(el, 'stroke-width'),\r\n            text: !el.childNodes || (el.childNodes.length === 1 && !(el.childNodes[0] as HTMLElement).tagName) ? el.textContent : undefined,\r\n            'font-size': el.getAttribute('font-size'),\r\n            'font': el.getAttribute('font'),\r\n            'text-anchor': el.getAttribute('text-anchor'),\r\n            style: {},\r\n            children: [],\r\n            globalElementIndex: -1,\r\n        };\r\n        \r\n        const clean = obj => {\r\n            const propNames = Object.getOwnPropertyNames(obj);\r\n            for (let i = 0; i < propNames.length; i++) {\r\n                const propName = propNames[i];\r\n                if (obj[propName] === null || obj[propName] === undefined) {\r\n                    delete obj[propName];\r\n                }\r\n            }\r\n        };\r\n        \r\n        clean(node);\r\n        \r\n        return node;\r\n    }\r\n    \r\n    private applyStyles() {\r\n        for (let i = 0; i < document.styleSheets.length; i++) {\r\n            const sheet = document.styleSheets[i] as any;\r\n            const rules = (sheet.rules ? sheet.rules : sheet.cssRules) as CSSRuleList;\r\n        \r\n            for (let j = 0; j < rules.length; j++) {\r\n                const rule = rules[j] as any;\r\n                const selector = rule.selectorText as string;\r\n                if(!selector) {\r\n                    continue; // Skip @imports etc.\r\n                }\r\n                this.applyRuleToMatchingNodes(selector, rule);\r\n            }\r\n        }\r\n\r\n        this.nodesToRestyle = [];\r\n    }\r\n\r\n    updateNodeSelector(oldSelector: string, newSelector: string) {\r\n        if(oldSelector === newSelector) {\r\n            return;\r\n        }\r\n        if(this.setAttrQueue[newSelector]) {\r\n            console.warn('having problems rearranging the elements! old:', oldSelector, ', new:', newSelector,\r\n                this.setAttrQueue[oldSelector], this.setAttrQueue[newSelector]);\r\n            delete this.setAttrQueue[oldSelector];\r\n        } else {\r\n            this.setAttrQueue[newSelector] = this.setAttrQueue[oldSelector];\r\n            delete this.setAttrQueue[oldSelector];\r\n        }\r\n    }\r\n\r\n    private applyRuleToMatchingNodes(selectorString: string, rule: {style: {[settingName: string]: string}}): boolean {\r\n\r\n        selectorString = selectorString.trim();\r\n\r\n        const selector = selectorString\r\n            .replace(' >', '>')\r\n            .replace('> ', '>')\r\n            .replace('svg>', '');\r\n        \r\n        const selectorPartsLooseStrict = selector.split(' ')\r\n            .map(part => part.split('>'));\r\n\r\n\r\n        const parentsOfInterest = [];\r\n        for(const nodeToBeStyled of this.nodesToRestyle) {\r\n            let parent = this.getNodeParent(nodeToBeStyled);\r\n            while(parent && parentsOfInterest.indexOf(parent) === -1) {\r\n                parentsOfInterest.push(parent);\r\n                parent = this.getNodeParent(parent);\r\n            }\r\n        }\r\n\r\n        const checkNode = (currentNode: VdomNode, looseIndex = 0, strictIndex = 0): boolean => {\r\n            const selPart = selectorPartsLooseStrict[looseIndex][strictIndex];\r\n\r\n            for(let childIndex = 0; childIndex < currentNode.children.length; childIndex++) {\r\n                const child = currentNode.children[childIndex];\r\n                if(parentsOfInterest.indexOf(child) === -1 && this.nodesToRestyle.indexOf(child) === -1) {\r\n                    continue;\r\n                }\r\n                let partialMatch = VdomManager.isCssRulePartialMatch(selPart, child, currentNode);\r\n\r\n                if(partialMatch) {\r\n                    if(selectorPartsLooseStrict[looseIndex].length > strictIndex + 1) {\r\n                        checkNode(child, looseIndex, strictIndex + 1);\r\n                    } else if(selectorPartsLooseStrict.length > looseIndex + 1) {\r\n                        checkNode(child, looseIndex + 1, strictIndex);\r\n                    } else {\r\n                        const parentSelector = this.getNodeSelector(currentNode);\r\n\r\n                        if(rule.style.stroke) {\r\n                            this.checkAttrName(parentSelector, 'style;stroke');\r\n                            if(!this.setAttrQueue[parentSelector]['style;stroke'][childIndex] && !child.style.stroke) {\r\n                                this.setAttrQueue[parentSelector]['style;stroke'][childIndex] = rule.style.stroke;\r\n                            }\r\n                        }\r\n                        if(rule.style['stroke-opacity']) {\r\n                            this.checkAttrName(parentSelector, 'style;stroke-opacity');\r\n                            if(!this.setAttrQueue[parentSelector]['style;stroke-opacity'][childIndex] && !child.style['stroke-opacity']) {\r\n                                this.setAttrQueue[parentSelector]['style;stroke-opacity'][childIndex] = rule.style['stroke-opacity'];\r\n                            }\r\n                        }\r\n                        if(rule.style['stroke-width']) {\r\n                            this.checkAttrName(parentSelector, 'style;stroke-width');\r\n                            if(!this.setAttrQueue[parentSelector]['style;stroke-width'][childIndex] && !child.style['stroke-width']) {\r\n                                this.setAttrQueue[parentSelector]['style;stroke-width'][childIndex] = parseInt(rule.style['stroke-width']);\r\n                            }\r\n                        }\r\n                        if(rule.style['stroke-linejoin']) {\r\n                            this.checkAttrName(parentSelector, 'style;stroke-linejoin');\r\n                            if(!this.setAttrQueue[parentSelector]['style;stroke-linejoin'][childIndex] && !child.style['stroke-linejoin']) {\r\n                                this.setAttrQueue[parentSelector]['style;stroke-linejoin'][childIndex] = rule.style['stroke-linejoin'];\r\n                            }\r\n                        }\r\n                        if(rule.style['fill-opacity']) {\r\n                            this.checkAttrName(parentSelector, 'style;fill-opacity');\r\n                            if(!this.setAttrQueue[parentSelector]['style;fill-opacity'][childIndex] && !child.style['fill-opacity']) {\r\n                                this.setAttrQueue[parentSelector]['style;fill-opacity'][childIndex] = rule.style['fill-opacity'];\r\n                            }\r\n                        }\r\n                        if(rule.style['fill']) {\r\n                            this.checkAttrName(parentSelector, 'style;fill');\r\n                            if(!this.setAttrQueue[parentSelector]['style;fill'][childIndex] && !child.style['fill']) {\r\n                                this.setAttrQueue[parentSelector]['style;fill'][childIndex] = rule.style['fill'];\r\n                            }\r\n                        }\r\n                        if(rule.style['font']) {\r\n                            this.checkAttrName(parentSelector, 'style;font');\r\n                            if(!this.setAttrQueue[parentSelector]['style;font'][childIndex] && !child.style['font']) {\r\n                                this.setAttrQueue[parentSelector]['style;font'][childIndex] = rule.style['font'];\r\n                            }\r\n                        }\r\n                    }\r\n                } else {\r\n                    if(child['removedClass']) {\r\n                        // temporarily add the class, see if it matches this rule, and if so, un-apply its stuff.\r\n                        child.className +=  ' ' + child['removedClass'];\r\n\r\n                        let newPartialMatch = VdomManager.isCssRulePartialMatch(selPart, child, currentNode);\r\n                        if(newPartialMatch) {\r\n                            const parentSelector = this.getNodeSelector(currentNode);\r\n                            this.removeRuleStylesFromNode(parentSelector, child, childIndex, rule);\r\n                        }\r\n\r\n                        child.className = child.className.substr(0, child.className.length -\r\n                           child['removedClass'].length - 1);\r\n                        delete child['removedClass'];\r\n                    }\r\n                    checkNode(child, looseIndex, strictIndex);\r\n                }\r\n            }\r\n            return false;\r\n        };\r\n\r\n        return checkNode(this.vdom.data);\r\n    }\r\n\r\n    removeRuleStylesFromNode(parentSelector: string, child: VdomNode, childIndex: number,\r\n                             rule: {style: {[settingName: string]: string}}) {\r\n        if(rule.style['stroke']) {\r\n            const color = drawingUtils.colorToRgba(rule.style['stroke']);\r\n            if(child.style['stroke'] === color || child.style['stroke-rgba'] === color) {\r\n                this.checkAttrName(parentSelector, 'style;stroke');\r\n                this.setAttrQueue[parentSelector]['style;stroke'][childIndex] = '';\r\n                this.checkAttrName(parentSelector, 'style;stroke-rgba');\r\n                this.setAttrQueue[parentSelector]['style;stroke-rgba'][childIndex] = '';\r\n            }\r\n        }\r\n        //TODO remove other styles.\r\n    }\r\n\r\n    removeNodeFromParent(element: Element, node: VdomNode) {\r\n        const parentSelector = element['parentSelector'];\r\n        const childIndex = element['childIndex'];\r\n        this.vdom.removeNode(childIndex, parentSelector);\r\n        let index = this.nodesToElements.nodes.indexOf(node);\r\n        if(index === -1) {\r\n            return console.error('node not found', node);\r\n        }\r\n\r\n        this.nodesToElements.nodes.splice(index, 1);\r\n        this.nodesToElements.elements.splice(index, 1);\r\n\r\n        // Remove all pending changes on this element\r\n        const selector = element['selector'];\r\n        delete this.setAttrQueue[selector];\r\n\r\n        // Update indices\r\n        for(let i = index; i < this.nodesToElements.nodes.length; i++) {\r\n            this.nodesToElements.nodes[i].globalElementIndex = i;\r\n        }\r\n\r\n        for(let attrName in this.setAttrQueue[parentSelector]) {\r\n            for(let i = childIndex + 1; i < this.setAttrQueue[parentSelector][attrName].length; i++) {\r\n                this.setAttrQueue[parentSelector][attrName][i-1] = this.setAttrQueue[parentSelector][attrName][i];\r\n            }\r\n        }\r\n    }\r\n\r\n    addNodeToParent(parentNode, node) {\r\n        parentNode.children.push(node);\r\n        this.nodesToRestyle.push(node);\r\n    }\r\n    \r\n    private addChildNodesToVisData(childEls: HTMLElement[]|NodeList, parentNode: VdomNode): void {\r\n        const parentEl = this.getElementFromNode(parentNode);\r\n\r\n        for(let i  = 0; i < childEls.length; i++) {\r\n            let el = childEls[i] as HTMLElement;\r\n            \r\n            try\r\n            {\r\n                const node = this.getNodeDataFromEl(el);\r\n\r\n                (el as any)['parentSelector'] = this.getElementSelector(parentEl);\r\n                (el as any)['selector'] = this.getElementSelector(<Element><any> el);\r\n                (el as any)['childIndex'] = parentNode.children.length;\r\n\r\n                parentNode.children.push(node);\r\n                this.linkNodeToElement(node, el);\r\n                this.nodesToRestyle.push(node);\r\n                \r\n                if(el.childNodes)\r\n                {\r\n                    this.addChildNodesToVisData(el.childNodes, node);\r\n                }\r\n                if(node.type === 'tspan')\r\n                {\r\n                    //console.log(node, el, el.childNodes, el.textContent);\r\n                    //console.log(el.childNodes[0])\r\n                    //console.log(node, style.textAnchor);\r\n                }\r\n                if(node.type === 'text')\r\n                {\r\n                    //console.log(node, el, el.childNodes, el.textContent);\r\n                }\r\n            }\r\n            catch(e)\r\n            {\r\n                //console.log(e);\r\n                //console.log(el);\r\n            }\r\n        }\r\n    }\r\n\r\n    getNodeSelector(node: VdomNode): string {\r\n        if(node === this.vdom.data) {\r\n            return 'svg';\r\n        }\r\n        const element = this.getElementFromNode(node);\r\n        if(!element) {\r\n            console.error('could not find element for node ', node);\r\n            return '';\r\n        }\r\n        return this.getElementSelector(element, undefined, node);\r\n    }\r\n    \r\n    getElementSelector(element: Element, parentNode?: VdomNode, node?: VdomNode): string|null {\r\n        let sel = (element as any)['selector'];\r\n        \r\n        if(sel)\r\n        {\r\n            return sel;\r\n        }\r\n        else\r\n        {\r\n            if(element === this.svg) {\r\n                sel = 'svg';\r\n            } else {\r\n                let parentSelector = (element as any)['parentSelector'] ?\r\n                    (element as any)['parentSelector'] as string : '';\r\n\r\n                if(!parentNode) {\r\n                    parentNode = this.vdom.getVisNodeFromSelector(parentSelector);\r\n                }\r\n                if(!parentNode) {\r\n                    console.warn('Element not found', element, parentSelector, parentSelector.length, this.vdom.data);\r\n                    return null;\r\n                }\r\n                let index = parentNode.children.length + 1;\r\n                if(node && parentNode.children.indexOf(node) !== -1) {\r\n                    index = parentNode.children.indexOf(node) + 1;\r\n                }\r\n                let name = element.localName;\r\n                if (!name) {\r\n                    console.error(parentNode);\r\n                    throw Error('name is null');\r\n                }\r\n                name = name.toLowerCase();\r\n                sel = this.combineElementSelectors(parentSelector, name, index);\r\n            }\r\n            \r\n            return sel;\r\n        }\r\n    }\r\n\r\n    combineElementSelectors(parentSelector: string, elementType: string, childIndex: number) {\r\n        return parentSelector + ' > ' + elementType + ':nth-child(' + childIndex + ')';\r\n    }\r\n\r\n    getNodeParent(node:VdomNode): VdomNode|null {\r\n        if(node === this.vdom.data) {\r\n            return null;\r\n        }\r\n        const el = this.getElementFromNode(node);\r\n        if(!el) {\r\n            return null;\r\n        }\r\n        const parentEl = el.parentNode as Element;\r\n        return this.getNodeFromElement(parentEl);\r\n    }\r\n\r\n    linkNodeToElement(node: VdomNode, element: Node) {\r\n        this.nodesToElements.nodes.push(node);\r\n        node.globalElementIndex = this.nodesToElements.elements.length;\r\n        this.nodesToElements.elements.push(element as Element);\r\n    }\r\n\r\n    getElementFromNode(node: VdomNode): Element {\r\n        if(node === this.vdom.data) {\r\n            return this.svg;\r\n        }\r\n        return this.nodesToElements.elements[node.globalElementIndex];\r\n    }\r\n\r\n    getNodeFromElement(element: Element): VdomNode {\r\n        if(element === this.svg) {\r\n            return this.vdom.data;\r\n        }\r\n        const elementIndex = this.nodesToElements.elements.indexOf(element);\r\n        return this.nodesToElements.nodes[elementIndex];\r\n    }\r\n\r\n    getParentNode(node: VdomNode): VdomNode|null {\r\n        const element = this.getElementFromNode(node);\r\n        const parentElement = element.parentNode as Element;\r\n        return this.getNodeFromElement(parentElement);\r\n    }\r\n\r\n    getTotalTransformation(node: VdomNode): Transformation {\r\n        let parent = this.getParentNode(node);\r\n        const parents = [node];\r\n\r\n        while(parent) {\r\n            parents.push(parent);\r\n            parent = this.getParentNode(parent);\r\n        }\r\n\r\n        parent = parents.pop();\r\n        let totalTransform: Transformation = {\r\n            translateX: 0,\r\n            translateY: 0,\r\n            scaleX: 0,\r\n            scaleY: 0,\r\n            rotate: 0,\r\n        };\r\n\r\n        while(parent) {\r\n            const transform = DrawingUtils.parseTransform(parent.transform);\r\n            totalTransform = DrawingUtils.addTransforms(totalTransform, transform);\r\n            parent = parents.pop();\r\n        }\r\n\r\n        return totalTransform;\r\n    }\r\n}\r\n\r\nlet safeLogCount = 0;\r\nfunction safeLog(...logContents) {\r\n    \r\n    if(safeLogCount < 50) {\r\n        safeLogCount++;\r\n        console.log(...logContents);\r\n    }\r\n}\r\nfunction safeErrorLog(...logContents) {\r\n    \r\n    if(safeLogCount < 50) {\r\n        safeLogCount++;\r\n        console.error(...logContents);\r\n    }\r\n}","import DrawingUtils from \"../canvasworker/drawingUtils\";\r\n\r\nexport class SetPropertyQueue {\r\n    [parentSelector: string]: {\r\n        [attrName: string]:\r\n            string[]|SharedArrayBuffer\r\n        \r\n    }\r\n}\r\n\r\nexport type VDOM = {\r\n    width: number;\r\n    height: number;\r\n    scale: number;\r\n} & VdomNode;\r\n\r\nexport type VdomNodeType = 'svg'|'g'|'rect'|'circle'|'path'|'title'|'tspan'|'text';\r\n\r\nexport type VdomNode = {\r\n    style: {[styleName: string]: string},\r\n    type: VdomNodeType,\r\n    children: VdomNode[],\r\n    globalElementIndex: number,\r\n    transform?: string,\r\n    fill?: string,\r\n    d?: string,\r\n    stroke?: string,\r\n    strokeWidth?: string,\r\n    cx?: number,\r\n    cy?: number,\r\n    r?: number,\r\n    x?: number,\r\n    y?: number,\r\n    x1?: number,\r\n    y1?: number,\r\n    x2?: number,\r\n    y2?: number,\r\n    dx?: string,\r\n    dy?: string,\r\n    width?: number,\r\n    height?: number,\r\n    textAlign?: string,\r\n    text?: string,\r\n    className?: string,\r\n    id?: string,\r\n}\r\n\r\nexport class VdomManager {\r\n    \r\n    constructor(public data: VDOM, private ignoreDesign = false) {\r\n        //console.log(data);\r\n    }\r\n\r\n    enableFrontendDesignProperties() {\r\n        this.ignoreDesign = false;\r\n    }\r\n    \r\n    addNode(nodeData: VdomNode, parentNodeSelector: string) {\r\n        let parentNode = this.getVisNodeFromSelector(parentNodeSelector);\r\n        if(!parentNode) {\r\n            if(parentNodeSelector === \"\") {\r\n                parentNode = this.data;\r\n            } else {\r\n                console.error(parentNode, parentNodeSelector);\r\n            }\r\n        }\r\n        this.applyParentStyles(parentNode, nodeData);\r\n        \r\n        if(!parentNode || !parentNode.children) {\r\n            console.error('parent node not found or no children: ', parentNode, parentNodeSelector, this.data);\r\n        }\r\n        \r\n        parentNode.children.push(nodeData);\r\n        return nodeData;\r\n    }\r\n\r\n    removeNode(childIndex: number, parentNodeSelector: string) {\r\n        let parentNode = this.getVisNodeFromSelector(parentNodeSelector);\r\n        if(!parentNode) {\r\n            if(parentNodeSelector === \"\") {\r\n                parentNode = this.data;\r\n            } else {\r\n                console.error(parentNode, parentNodeSelector);\r\n            }\r\n        }\r\n\r\n        parentNode.children.splice(childIndex, 1);\r\n        this.cachedListSelections = {}; //TODO only remove relevant cache.\r\n    }\r\n\r\n    applyParentStyles(parentNode: VdomNode, childNode: VdomNode) {\r\n        for(const style in parentNode.style) {\r\n            if(!childNode.style[style]) {\r\n                childNode.style[style] = parentNode.style[style];\r\n            }\r\n        }\r\n    }\r\n    \r\n    getParentNodeFromSelector(parentSelector: string) {\r\n        if(!parentSelector) {\r\n            console.error('no parent selector', parentSelector);\r\n        }\r\n        //if(setAttrQueue.hasOwnProperty(parentSelector)) {\r\n        let parentNode;\r\n        if(parentSelector === 'SVG_PARENT') {\r\n            parentNode = {children: [this.data]};\r\n        } else {\r\n            parentNode = this.getVisNodeFromSelector(parentSelector);\r\n        }\r\n        if(!parentNode) {\r\n            console.error('parent node not found with selector', parentSelector);\r\n        }\r\n        return parentNode;\r\n    }\r\n\r\n    applyStyleToNodeAndChildren(node: VdomNode, styleName: string, styleValue: string) {\r\n        node['style'][styleName] = styleValue;\r\n\r\n        if(node.children) {\r\n            for(let child of node.children) {\r\n                this.applyStyleToNodeAndChildren(child, styleName, styleValue);\r\n            }\r\n        }\r\n    }\r\n\r\n    private static ROUNDED_ATTRS = ['cx', 'cy'];\r\n\r\n    updatePropertiesFromQueue(setAttrQueue: SetPropertyQueue) {\r\n        for(let parentSelector in setAttrQueue) {\r\n            if(!setAttrQueue[parentSelector]) {\r\n                continue;\r\n            }\r\n            const parentNode = this.getParentNodeFromSelector(parentSelector);\r\n            if(!parentNode) {\r\n                console.error('parent not found', parentSelector, setAttrQueue[parentSelector]);\r\n                continue;\r\n            }\r\n                \r\n            for(let attrName in setAttrQueue[parentSelector]) {\r\n                const attrNameStart = attrName.substr(0, 'style;'.length);\r\n\r\n                if(this.ignoreDesign && (attrNameStart === 'style;' ||\r\n                    ['fill', 'stroke', 'opacity', 'x1', 'x2', 'y1', 'y2'].indexOf(attrName) !== -1)) {\r\n                    continue;\r\n                }\r\n                \r\n                let values: string[]|Int32Array;\r\n                let factor: number;\r\n                \r\n                if('SharedArrayBuffer' in self &&\r\n                    setAttrQueue[parentSelector][attrName] instanceof SharedArrayBuffer) {\r\n                    values = new Int32Array(<ArrayBuffer> setAttrQueue[parentSelector][attrName]);\r\n                    factor = 0.1;\r\n                } else {\r\n                    values = setAttrQueue[parentSelector][attrName] as string[];\r\n                }\r\n                \r\n                for(let childIndex in values) {\r\n                    const childNode = parentNode.children[childIndex];\r\n                    if(!childNode) {\r\n                        continue;\r\n                    }\r\n                    let value = factor ? factor * <number> values[childIndex] : values[childIndex];\r\n                    if(attrNameStart === 'style;') {\r\n                        const styleName = attrName.substr('style;'.length);\r\n                        this.applyStyleToNodeAndChildren(childNode, styleName, <string> value);\r\n                        this.updateDeducedStyles(childNode, styleName, <string> value);\r\n                    } else {\r\n                        if(VdomManager.ROUNDED_ATTRS.indexOf(attrName) !== -1) {\r\n                            value = Math.round(<number> value);\r\n                        }\r\n                        childNode[attrName] = value;\r\n                        this.updateDeducedStyles(childNode, attrName, <string> value);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    updateDeducedStyles(node: VdomNode, attrName: string, value: string) {\r\n        if(['opacity', 'fill-opacity', 'stroke-opacity', 'stroke', 'fill'].indexOf(attrName) !== -1) {\r\n            let stroke = node.style.stroke ? node.style.stroke : node.stroke;\r\n            if(stroke) {\r\n                let strokeOpacity = node.style['stroke-opacity'] === undefined ? node.style['opacity']\r\n                    : node.style['stroke-opacity'];\r\n                if(strokeOpacity === undefined) {\r\n                    strokeOpacity = node['stroke-opacity'] === undefined ? node['opacity'] : node['stroke-opacity'];\r\n                }\r\n\r\n                node.style['stroke-rgba'] = DrawingUtils.colorToRgba(stroke, strokeOpacity);\r\n            }\r\n        }\r\n    }\r\n    \r\n    private cachedListSelections: {[selector: string]: {[index: number]: VdomNode}} = {};\r\n    public getVisNodeFromSelector(selector: string): VdomNode|null {\r\n        const lastSplitPos = selector.lastIndexOf('>');\r\n        const selectorWithoutLast = selector.substr(0, lastSplitPos);\r\n        const lastPart = selector.substr(lastSplitPos + 1);\r\n        const parentSel = selectorWithoutLast ? this.cachedListSelections[selectorWithoutLast] : null;\r\n        let index = -1;\r\n        const nthChildPosition = lastPart.indexOf(':nth-child(');\r\n        if(nthChildPosition !== -1) {\r\n            index = parseInt(lastPart.substr(nthChildPosition + 11)); // length of ':nth-child('\r\n            if(parentSel && parentSel[index]) {\r\n                return parentSel[index];\r\n            }\r\n        }\r\n        \r\n        const selectedNodes: VdomNode[] = [];\r\n        this.findMatchingChildren(this.data, selector, 0, selectedNodes);\r\n        \r\n        if(selectedNodes && selectedNodes.length === 1) {\r\n            const el = selectedNodes[0];\r\n            if(index !== -1) {\r\n                if(!this.cachedListSelections[selectorWithoutLast]) {\r\n                    this.cachedListSelections[selectorWithoutLast] = {};\r\n                }\r\n                this.cachedListSelections[selectorWithoutLast][index] = el;\r\n            }\r\n            return el;\r\n        }\r\n        return null;\r\n    }\r\n    \r\n    public getVisNodesFromSelector(visNode: VdomNode, selector: string) {\r\n        const selectedNodes = [];\r\n        this.findMatchingChildren(visNode, selector, 0, selectedNodes);\r\n        return selectedNodes;\r\n    }\r\n\r\n    private findChildrenOfType(visNode: VdomNode, type: string, selectedNodes: VdomNode[]) {\r\n        const addDirectChildrenIfMatch = (node: VdomNode) => {\r\n            for(const child of node.children) {\r\n                if(child.type === type) {\r\n                    selectedNodes.push(child);\r\n                }\r\n                if(node.children.length !== 0) {\r\n                    addDirectChildrenIfMatch(child);\r\n                }\r\n            }\r\n        };\r\n        addDirectChildrenIfMatch(visNode);\r\n    }\r\n\r\n    public filterNodesBySelector(parentNode: VdomNode, nodes: VdomNode[], selector: string) {\r\n        return nodes.filter(node => VdomManager.isCssRulePartialMatch(selector, node, parentNode));\r\n    }\r\n    \r\n    private findMatchingChildren(visNode: VdomNode, selector: string, matchIndex: number, selectedNodes: VdomNode[],\r\n                                 selectedNodeSelectors: string[] = []) {\r\n        if(!selector && selector !== '') {\r\n            console.error(visNode, selector, matchIndex, selectedNodes, selectedNodeSelectors);\r\n            throw Error('undefined selector');\r\n        }\r\n\r\n        let selParts = selector.split('>').map(s => s.trim());\r\n        let selPart = selParts[matchIndex];\r\n        \r\n        if(matchIndex === 0 && selPart === 'svg') {\r\n            matchIndex++;\r\n            selPart = selParts[matchIndex];\r\n            if(matchIndex === selParts.length) {\r\n                selectedNodes.push(visNode);\r\n                selectedNodeSelectors.push(selector);\r\n                return;\r\n            }\r\n        }\r\n\r\n        if(selector.match(/^[a-z]+$/)) {\r\n            return this.findChildrenOfType(visNode, selector, selectedNodes);\r\n        }\r\n        \r\n        for(let i = 0; i < visNode.children.length; i++) {\r\n            let node = visNode.children[i];\r\n            let matching = false;\r\n            \r\n            if(VdomManager.isCssRulePartialMatch(selPart, node, visNode)) {\r\n                if(matchIndex === selParts.length - 1) {\r\n                    selectedNodes.push(node);\r\n                    selectedNodeSelectors.push(selector);\r\n                } else {\r\n                    matching = true;\r\n                }\r\n            }\r\n            \r\n            if(node.children && (matching || selParts.length < 2) && matchIndex + 1 < selParts.length) {\r\n                this.findMatchingChildren(node, selector, matchIndex + 1, selectedNodes, selectedNodeSelectors);\r\n            }\r\n        }\r\n    }\r\n\r\n    public static isCssRulePartialMatch(cssRuleSelectorPart: string, node: VdomNode, parentNode: VdomNode): boolean {\r\n        if(cssRuleSelectorPart.substr(0, 5) === ':not(') {\r\n            const newSelPart = cssRuleSelectorPart.substr(0, cssRuleSelectorPart.length - 1).substr(5);\r\n            return !VdomManager.isCssRulePartialMatch(newSelPart, node, parentNode);\r\n        }\r\n        if(cssRuleSelectorPart[0] === '.') { // Example: .className\r\n            if(node.className && node.className.split(' ').indexOf(cssRuleSelectorPart.substr(1)) !== -1) {\r\n                return true;\r\n            }\r\n        } else if(cssRuleSelectorPart[0] === '#') { // Example: #id\r\n            if(cssRuleSelectorPart.substr(1) === node.id) {\r\n                return true;\r\n            }\r\n        } else if(cssRuleSelectorPart.match(/^[a-z]+$/)) { // Example: rect\r\n            if(cssRuleSelectorPart === node.type) {\r\n                return true;\r\n            }\r\n        } else if(cssRuleSelectorPart.indexOf(':nth-child(') !== -1) {\r\n            let type = 'any';\r\n            let indexPart = cssRuleSelectorPart;\r\n\r\n            if(cssRuleSelectorPart[0] !== ':') {\r\n                type = cssRuleSelectorPart.substr(0, cssRuleSelectorPart.indexOf(':'));\r\n                indexPart = cssRuleSelectorPart.substr(cssRuleSelectorPart.indexOf(':'));\r\n            }\r\n\r\n            const targetIndex = parseInt(indexPart.substr(':nth-child('.length));\r\n            const index = parentNode.children.indexOf(node);\r\n\r\n            return (index === targetIndex - 1 && (type === 'any' || node.type === type));\r\n        }\r\n        else if(cssRuleSelectorPart.indexOf('.') !== -1) { // Example: rect.className\r\n            const cutoff = cssRuleSelectorPart.indexOf('.');\r\n            const typeName = cssRuleSelectorPart.substr(0, cutoff);\r\n            const className = cssRuleSelectorPart.substr(cutoff + 1);\r\n            if(typeName === node.type && node.className && node.className.split(' ').indexOf(className) !== -1) {\r\n                return true;\r\n            }\r\n        }\r\n        return false;\r\n    }\r\n}\r\n\r\nlet safeLogCount = 0;\r\nfunction safeLog(...logContents) {\r\n    if(safeLogCount < 50) {\r\n        safeLogCount++;\r\n        console.log(...logContents);\r\n    }\r\n}\r\nfunction safeErrorLog(...logContents) {\r\n    if(safeLogCount < 50) {\r\n        safeLogCount++;\r\n        console.error(...logContents);\r\n    }\r\n}","import {VdomManager, VdomNode} from \"../util/vdomManager\";\r\nimport DrawingUtils from \"./drawingUtils\";\r\nimport CanvasWorker from \"./canvasworker\";\r\n\r\nexport default class Canvasrenderer implements CanvasWorker {\r\n    \r\n    private ctx: CanvasRenderingContext2D;\r\n    \r\n    constructor(private vdom: VdomManager, private canvas: HTMLCanvasElement,\r\n                private forceSingle = false, private onDrawn = () => {}) {\r\n        const ctx = canvas.getContext('2d');\r\n        if(!ctx) throw new Error('could not create canvas context');\r\n        \r\n        this.ctx = ctx;\r\n        this.ctx.scale(this.vdom.data.scale, this.vdom.data.scale);\r\n        this.ctx.save();\r\n        \r\n        this.draw();\r\n        \r\n        setTimeout(() => {\r\n            console.log(this.forceSingle, this.vdom.data);\r\n            this.draw();\r\n        }, 1000);\r\n    }\r\n    \r\n    //private lastDrawn: VdomNode = null;\r\n    private lastFullSecond = 0;\r\n    private countSinceLastFullSecond = 0;\r\n    \r\n    draw() {\r\n        const ctx = this.ctx;\r\n        \r\n        ctx.restore();\r\n        ctx.save();\r\n        \r\n        //ctx.fillStyle = '#fff';\r\n        //ctx.fillRect(0, 0, this.vdom.data.width, this.vdom.data.height);\r\n        ctx.clearRect(0, 0, this.vdom.data.width, this.vdom.data.height);\r\n    \r\n        //this.lastDrawn = null;\r\n        this.drawLine(null, 'start');\r\n        this.drawCircle(null, 'start');\r\n        this.drawRect(null, 'start');\r\n        this.drawText(null, 'start');\r\n\r\n        this.drawNodeAndChildren(this.vdom.data, this.forceSingle);\r\n\r\n        this.drawLine(null, 'end');\r\n        this.drawCircle(null, 'end');\r\n        this.drawRect(null, 'end');\r\n        this.drawText(null, 'end');\r\n        \r\n        this.onDrawn();\r\n    \r\n        const fullSecond = Math.round(performance.now() / 1000);\r\n        if(fullSecond !== this.lastFullSecond) {\r\n            this.lastFullSecond = fullSecond;\r\n            //console.log(this.countSinceLastFullSecond);\r\n            this.countSinceLastFullSecond = 0;\r\n        }\r\n        this.countSinceLastFullSecond++;\r\n    }\r\n    \r\n    private drawNodeAndChildren(elData: VdomNode, forceSingle: boolean) {\r\n        const ctx = this.ctx;\r\n\r\n        ctx.save();\r\n        const hasTransformed = this.applyTransform(elData.transform);\r\n\r\n        if(elData.transform) {\r\n            forceSingle = true;\r\n        }\r\n        \r\n        if(elData.type && elData.type !== 'g' && (!elData.style.display || elData.style.display !== 'none')) {\r\n            if(elData.type === 'title') {\r\n                return;\r\n            }\r\n            \r\n            if(!forceSingle) {\r\n                /*if(!this.lastDrawn || (this.lastDrawn && this.lastDrawn.type !== elData.type)) {\r\n                    if(this.lastDrawn) {\r\n                        this.drawSingleNode(this.lastDrawn, 'end');\r\n                    }\r\n                    this.drawSingleNode(elData, 'start');\r\n                }*/\r\n    \r\n                this.drawSingleNode(elData);\r\n            } else {\r\n                this.drawSingleNode(elData, 'forcesingle');\r\n            }\r\n            \r\n            //this.lastDrawn = elData;\r\n        }\r\n        \r\n        if(elData.children) {\r\n            for(let i = 0; i < elData.children.length; i++) {\r\n                this.drawNodeAndChildren(elData.children[i], forceSingle);\r\n            }\r\n        }\r\n        ctx.restore();\r\n        if(hasTransformed) {\r\n            //ctx.restore();\r\n        }\r\n    }\r\n    \r\n    private drawSingleNode(elData: VdomNode, mode: ('start'|'normal'|'end'|'forcesingle') = 'normal') {\r\n        const type: string = elData.type;\r\n        const drawFct = this['draw' + type.substr(0,1).toUpperCase() + type.substr(1)];\r\n        if(!drawFct) {\r\n            return console.error('no draw function yet for ', type);\r\n        }\r\n        drawFct.call(this, elData, mode);\r\n    }\r\n\r\n    private drawClippath(elData: VdomNode) {\r\n        console.warn('clippaths can not be rendered yet.')\r\n    }\r\n    \r\n    private circlesByColor: {[color: string]: VdomNode[]} = {};\r\n    private drawCircle(elData: VdomNode, mode: ('start'|'normal'|'end'|'forcesingle') = 'normal') {\r\n        if(mode === 'normal') {\r\n            let fill = elData.style.fill ? elData.style.fill : elData.fill;\r\n            let fillOpacity = elData.style['fill-opacity'] ? elData.style['fill-opacity'] : elData.style['opacity'];\r\n            if(!fill) fill = 'rgb(0,0,0)';\r\n            const fillRgba = DrawingUtils.colorToRgba(fill, fillOpacity);\r\n            const stroke = this.getStrokeStyle(elData);\r\n            const handle = fillRgba + ';' + stroke;\r\n            if(!this.circlesByColor[handle]) {\r\n                this.circlesByColor[handle] = [];\r\n            }\r\n            this.circlesByColor[handle].push(elData);\r\n        }\r\n        if(mode === 'start') {\r\n            this.circlesByColor = {};\r\n            return;\r\n        }\r\n        if(mode === 'end') {\r\n            for(let fillAndStrokeColor in this.circlesByColor) {\r\n                if(this.circlesByColor.hasOwnProperty(fillAndStrokeColor)) {\r\n                    const split = fillAndStrokeColor.split(';');\r\n                    const fillColor = split[0];\r\n                    const strokeColor = split[1];\r\n\r\n                    this.ctx.fillStyle = fillColor;\r\n                    let sampleData = this.circlesByColor[fillAndStrokeColor][0];\r\n                    const lineWidth = sampleData.style['stroke-width'] ?\r\n                        parseFloat(sampleData.style['stroke-width']) : parseFloat(sampleData.strokeWidth);\r\n                    this.ctx.lineWidth = lineWidth ? lineWidth : 1;\r\n                    this.ctx.strokeStyle = strokeColor;\r\n\r\n                    this.ctx.beginPath();\r\n                    for(let elData of this.circlesByColor[fillAndStrokeColor]) {\r\n                        const cx = elData.cx ? elData.cx : 0;\r\n                        const cy = elData.cy ? elData.cy : 0;\r\n                        const r = elData.r;\r\n                        this.ctx.save();\r\n                        this.applyTransform(elData.transform);\r\n                        this.ctx.moveTo(cx + r, cy);\r\n                        this.ctx.arc(cx, cy, r, 0, 2 * Math.PI);\r\n                        this.ctx.restore();\r\n                        //this.ctx.restore();\r\n                    }\r\n\r\n                    if(fillColor !== 'none'){\r\n                        this.ctx.fill();\r\n                    }\r\n\r\n                    if(sampleData.style['stroke-rgba'] && sampleData.style['stroke-rgba'] !== 'none') {\r\n                        this.ctx.stroke();\r\n                    }\r\n                }\r\n            }\r\n            return;\r\n        }\r\n        if(mode === 'forcesingle') {\r\n            let fill = elData.style.fill ? elData.style.fill : elData.fill;\r\n            if(!fill) fill = '#000';\r\n            let fillOpacity = elData.style['fill-opacity'] ? elData.style['fill-opacity'] : elData.style['opacity'];\r\n\r\n            const cx = elData.cx || 0;\r\n            const cy = elData.cy || 0;\r\n\r\n            this.ctx.beginPath();\r\n            this.ctx.fillStyle = DrawingUtils.colorToRgba(fill, fillOpacity);\r\n            this.ctx.strokeStyle = this.getStrokeStyle(elData);\r\n            this.ctx.lineWidth = elData.style['stroke-width'] ?\r\n                parseFloat(elData.style['stroke-width']) : parseFloat(elData.strokeWidth);\r\n            this.ctx.arc(cx, cy, elData.r, 0, 2 * Math.PI);\r\n            if(fill !== 'none'){\r\n                this.ctx.fill();\r\n            }\r\n\r\n            if(elData.style['stroke-rgba'] && elData.style['stroke-rgba'] !== 'none') {\r\n                this.ctx.stroke();\r\n            }\r\n        }\r\n    }\r\n\r\n    private getFillStyle(node: VdomNode): string {\r\n        let fill = node.style.fill ? node.style.fill : node.fill;\r\n        let opacity = node.style['fill-opacity'] ? node.style['fill-opacity'] : node.style['opacity'];\r\n        fill = DrawingUtils.colorToRgba(fill, opacity);\r\n        return fill;\r\n    }\r\n\r\n    private getStrokeStyle(node: VdomNode): string {\r\n        if(node.style['stroke-rgba']) {\r\n            return node.style['stroke-rgba'];\r\n        }\r\n        let stroke = node.style.stroke ? node.style.stroke : node.stroke;\r\n        if(stroke) {\r\n            let strokeOpacity = node.style['stroke-opacity'] === undefined ? node.style['opacity']\r\n                : node.style['stroke-opacity'];\r\n            if(strokeOpacity === undefined) {\r\n                strokeOpacity = node['stroke-opacity'] === undefined ? node['opacity'] : node['stroke-opacity'];\r\n            }\r\n\r\n            node.style['stroke-rgba'] = DrawingUtils.colorToRgba(stroke, strokeOpacity);\r\n            return node.style['stroke-rgba'];\r\n        }\r\n        return 'none';\r\n    }\r\n\r\n    private rectsByColor = {};\r\n\r\n    private drawRect(elData: VdomNode, mode: ('start'|'normal'|'end'|'forcesingle') = 'normal') {\r\n\r\n        if(mode === 'normal') {\r\n            let fill = elData.style.fill ? elData.style.fill : elData.fill;\r\n            let fillOpacity = elData['fill-opacity'] ? elData['fill-opacity'] : elData['opacity'];\r\n            let fillOpacityStyle = elData.style['fill-opacity'] ? elData.style['fill-opacity'] : elData.style['opacity'];\r\n\r\n            if(fillOpacityStyle !== undefined) {\r\n                fillOpacity = fillOpacityStyle;\r\n            }\r\n\r\n            //if(!fill) fill = '#000';\r\n            const fillRgba = DrawingUtils.colorToRgba(fill, fillOpacity);\r\n            const stroke = this.getStrokeStyle(elData);\r\n            const handle = fillRgba + ';' + stroke;\r\n            if(!this.rectsByColor[handle]) {\r\n                this.rectsByColor[handle] = [];\r\n            }\r\n            this.rectsByColor[handle].push(elData);\r\n        }\r\n        if(mode === 'start') {\r\n            this.rectsByColor = {};\r\n            return;\r\n        }\r\n        if(mode === 'end') {\r\n            for(let fillAndStrokeColor in this.rectsByColor) {\r\n                if(this.rectsByColor.hasOwnProperty(fillAndStrokeColor)) {\r\n                    const split = fillAndStrokeColor.split(';');\r\n                    const fillColor = split[0];\r\n                    const strokeColor = split[1];\r\n                    this.ctx.fillStyle = fillColor;\r\n\r\n                    let sampleData = this.rectsByColor[fillAndStrokeColor][0];\r\n                    const lineWidth = sampleData.style['stroke-width'] ?\r\n                        parseFloat(sampleData.style['stroke-width']) : parseFloat(sampleData.strokeWidth);\r\n                    this.ctx.lineWidth = lineWidth ? lineWidth : 1;\r\n                    this.ctx.strokeStyle = strokeColor;\r\n\r\n                    this.ctx.beginPath();\r\n                    for(let elData of this.rectsByColor[fillAndStrokeColor]) {\r\n                        const cx = elData.cx ? elData.cx : 0;\r\n                        const cy = elData.cy ? elData.cy : 0;\r\n                        const r = elData.r;\r\n                        this.ctx.save();\r\n                        this.applyTransform(elData.transform);\r\n                        this.ctx.moveTo(cx + r, cy);\r\n                        this.ctx.rect(elData.x, elData.y, elData.width, elData.height);\r\n                        this.ctx.restore();\r\n                        //this.ctx.restore();\r\n                    }\r\n                    if(fillColor !== 'none'){\r\n                        this.ctx.fill();\r\n                    }\r\n\r\n                    if(sampleData.style['stroke-rgba'] && sampleData.style['stroke-rgba'] !== 'none') {\r\n                        this.ctx.stroke();\r\n                    }\r\n                }\r\n            }\r\n            return;\r\n        }\r\n        if(mode === 'forcesingle') {\r\n            let fill = elData.style.fill ? elData.style.fill : elData.fill;\r\n            if(fill) {\r\n                fill = DrawingUtils.colorToRgba(fill, elData.style['fill-opacity']);\r\n            }\r\n\r\n            if(fill && fill !== 'none') {\r\n                this.ctx.fillStyle = elData.style.fill ? elData.style.fill : elData.fill;\r\n                this.ctx.fillRect(elData.x, elData.y, elData.width, elData.height);\r\n            }\r\n\r\n            let stroke = elData.style.stroke ? elData.style.stroke : elData.stroke;\r\n            if(stroke) {\r\n                stroke = DrawingUtils.colorToRgba(stroke, elData.style['stroke-opacity']);\r\n                this.ctx.strokeStyle = stroke;\r\n                this.ctx.beginPath();\r\n                this.ctx.rect(elData.x, elData.y, elData.width, elData.height);\r\n                this.ctx.stroke();\r\n            }\r\n        }\r\n    }\r\n\r\n    private drawTexts: VdomNode[] = [];\r\n\r\n    private drawText(node: VdomNode, mode: ('start'|'normal'|'end'|'forcesingle') = 'normal') {\r\n        const drawSingle = (elData: VdomNode) => {\r\n            if(elData.text === '') {\r\n                return;\r\n            }\r\n            const fontFamily = 'Arial';\r\n            const fontSize = elData['font-size'] ? DrawingUtils.convertSizeToPx(elData['font-size']) + 'px' : '30px';\r\n            let font = elData.style['font'] ? elData.style['font'] : elData['font'];\r\n            if(!font) {\r\n                font = fontSize + ' ' + fontFamily;\r\n            }\r\n            if(elData['text-anchor']) {\r\n                const align = elData['text-anchor'] === 'middle' ? 'center' : elData['text-anchor'];\r\n                this.ctx.textAlign = align;\r\n            }\r\n            let fill = elData['fill'] ? elData['fill'] : elData.style['fill'];\r\n            if(!fill) fill = '#000';\r\n            this.ctx.font = font;\r\n            this.ctx.fillStyle = fill;\r\n            let x = elData.x || 0;\r\n            let y = elData.y || 0;\r\n            let dx = DrawingUtils.convertSizeToPx(elData.dx, false) || 0;\r\n            let dy = DrawingUtils.convertSizeToPx(elData.dy, false) || 0;\r\n            this.ctx.fillText(elData.text, x + dx, y + dy);\r\n        };\r\n        if(mode === 'start') {\r\n            this.drawTexts = [];\r\n            return;\r\n        }\r\n        if(mode === 'normal') {\r\n            this.drawTexts.push(node);\r\n            return;\r\n        }\r\n        if(mode === 'forcesingle') {\r\n            return drawSingle(node);\r\n        }\r\n        if(mode === 'end') {\r\n            for(const currentNode of this.drawTexts) {\r\n                drawSingle(currentNode);\r\n            }\r\n            return;\r\n        }\r\n    }\r\n\r\n    private drawPath(elData: VdomNode, mode: ('start'|'normal'|'end'|'forcesingle') = 'normal') {\r\n        if(mode !== 'normal' && mode !== 'forcesingle') return;\r\n\r\n        const fill = this.getFillStyle(elData);\r\n        const stroke = this.getStrokeStyle(elData);\r\n        const strokeWidth = elData.style['stroke-width'] ? elData.style['stroke-width'] : elData['stroke-width'];\r\n\r\n        let p = new Path2D(elData.d);\r\n        this.ctx.fillStyle = fill;\r\n        if(stroke && stroke !== 'none') {\r\n            if(strokeWidth) {\r\n                this.ctx.lineWidth = strokeWidth;\r\n                this.ctx.strokeStyle = stroke;\r\n            } else {\r\n                this.ctx.strokeStyle = stroke;\r\n            }\r\n            if(elData.style['stroke-linejoin']) {\r\n                const lineJoin = elData.style['stroke-linejoin'];\r\n                if(lineJoin === 'bevel' || lineJoin === 'round' || lineJoin === 'miter') {\r\n                    this.ctx.lineJoin = lineJoin;\r\n                } else {\r\n                    console.error('unknown line join value:', lineJoin)\r\n                }\r\n            }\r\n            this.ctx.stroke(p);\r\n        }\r\n\r\n        if(fill && fill !== 'none') {\r\n            this.ctx.fill(p);\r\n        }\r\n    }\r\n    \r\n    private drawTspan(elData: VdomNode, mode: ('start'|'normal'|'end'|'forcesingle') = 'normal') {\r\n        if(mode !== 'normal' && mode !== 'forcesingle') return;\r\n        \r\n        this.ctx.font = \"10px Arial\";\r\n        this.ctx.fillStyle = \"#000000\";\r\n        const textAlign = <CanvasTextAlign> (elData.style.textAnchor === \"middle\" ? \"center\" : elData.style.textAnchor);\r\n        this.ctx.textAlign = textAlign;\r\n        this.ctx.fillText(elData.text, elData.x, elData.y);\r\n    }\r\n\r\n    private drawTextpath(elData: VdomNode) {\r\n        console.warn('no draw function yet for textpath');\r\n    }\r\n\r\n    private linesByColor: {[color: string]: VdomNode[]} = {};\r\n    private drawLine(elData, mode: ('start'|'normal'|'end'|'forcesingle') = 'normal') {\r\n        if(this.vdom.data.scale > 1) {\r\n            //mode = 'forcesingle';\r\n            // In my tests, drawing a long connected path is very slow for high DPI devices.\r\n        }\r\n        if(mode === 'normal') {\r\n            const stroke = this.getStrokeStyle(elData);\r\n            if(stroke === 'none') {\r\n                return;\r\n            }\r\n            if(!this.linesByColor[stroke]) {\r\n                this.linesByColor[stroke] = [];\r\n            }\r\n            this.linesByColor[stroke].push(elData);\r\n        }\r\n        if(mode === 'start') {\r\n            this.linesByColor = {};\r\n            return;\r\n        }\r\n        if(mode === 'end') {\r\n            for(let strokeColor in this.linesByColor) {\r\n                if(this.linesByColor.hasOwnProperty(strokeColor)) {\r\n                    this.ctx.strokeStyle = strokeColor;\r\n\r\n                    let sampleData = this.linesByColor[strokeColor][0];\r\n                    this.ctx.lineWidth = sampleData.style['stroke-width'] ?\r\n                        parseFloat(sampleData.style['stroke-width']) : parseFloat(sampleData['stroke-width']);\r\n\r\n                    this.ctx.beginPath();\r\n                    for(let elData of this.linesByColor[strokeColor]) {\r\n                        this.ctx.save();\r\n                        this.applyTransform(elData.transform);\r\n                        this.ctx.moveTo(elData.x1, elData.y1);\r\n                        this.ctx.lineTo(elData.x2, elData.y2);\r\n                        this.ctx.restore();\r\n                        //this.ctx.restore();\r\n                    }\r\n\r\n                    this.ctx.stroke();\r\n                }\r\n            }\r\n            return;\r\n        }\r\n        if(mode === 'forcesingle') {\r\n            this.ctx.beginPath();\r\n            this.ctx.moveTo(elData.x1, elData.y1);\r\n            this.ctx.lineTo(elData.x2, elData.y2);\r\n\r\n            this.ctx.strokeStyle = elData.style['stroke-rgba'];\r\n            //safeLog(stroke, this.ctx.strokeStyle);\r\n            this.ctx.stroke();\r\n        }\r\n    }\r\n\r\n    private drawDefs(node: VdomNode) {\r\n        //TODO figure out.\r\n    }\r\n\r\n    private drawMarker(node: VdomNode) {\r\n        //TODO figure out.\r\n    }\r\n    \r\n    private applyTransform(transformString: string) {\r\n        const transform = transformString ? DrawingUtils.parseTransform(transformString) : null;\r\n        if(transform) {\r\n            if(transform.rotate) {\r\n                //console.log(transform.rotate);\r\n            }\r\n            //console.log(transformString);\r\n            this.ctx.transform(transform.scaleX, 0, 0, transform.scaleY, transform.translateX, transform.translateY);\r\n            //ctx.rotate(transform.rotate / 2 / Math.PI);\r\n            this.ctx.rotate(transform.rotate * Math.PI / 180);\r\n            //console.log(transform.rotate);\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n}\r\n\r\n\r\nlet safeLogCount = 0;\r\nfunction safeLog(...logContents) {\r\n    \r\n    if(safeLogCount < 50) {\r\n        safeLogCount++;\r\n        console.log(...logContents);\r\n    }\r\n}\r\nfunction safeErrorLog(...logContents) {\r\n    \r\n    if(safeLogCount < 50) {\r\n        safeLogCount++;\r\n        console.error(...logContents);\r\n    }\r\n}","import './custom';\r\nimport CanvasWorkerImporter = require('worker-loader?inline=true!./canvasworker');\r\n\r\nexport default CanvasWorkerImporter;","module.exports = function() {\n  return require(\"!!C:\\\\Users\\\\Tom Horak\\\\research\\\\wristvis\\\\ssvg\\\\node_modules\\\\worker-loader\\\\dist\\\\workers\\\\InlineWorker.js\")(\"!function(t){var e={};function s(r){if(e[r])return e[r].exports;var l=e[r]={i:r,l:!1,exports:{}};return t[r].call(l.exports,l,l.exports,s),l.l=!0,l.exports}s.m=t,s.c=e,s.d=function(t,e,r){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},s.r=function(t){\\\"undefined\\\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:\\\"Module\\\"}),Object.defineProperty(t,\\\"__esModule\\\",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&\\\"object\\\"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,\\\"default\\\",{enumerable:!0,value:t}),2&e&&\\\"string\\\"!=typeof t)for(var l in t)s.d(r,l,function(e){return t[e]}.bind(null,l));return r},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,\\\"a\\\",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p=\\\"\\\",s(s.s=1)}([function(t,e,s){\\\"use strict\\\";Object.defineProperty(e,\\\"__esModule\\\",{value:!0});class r{static parseTransform(t){const e={translateX:0,translateY:0,scaleX:1,scaleY:1,rotate:0,translateBeforeScale:!1};if(t){if(\\\"string\\\"!=typeof t)return e.scaleX=t.k,e.scaleY=t.k,e.translateX=t.x,e.translateY=t.y,e;let s=t;s=s.replace(/ /g,\\\"\\\");const r=/\\\\s*translate\\\\(([-0-9.]+),([-0-9.]+)\\\\)/.exec(s);r&&(e.translateX=parseFloat(r[1]),e.translateY=parseFloat(r[2]));const l=/\\\\s*scale\\\\(([-0-9.]+)\\\\)/.exec(s);l&&(e.scaleX=parseFloat(l[1]),e.scaleY=parseFloat(l[1]));const o=/\\\\s*rotate\\\\(([-0-9.]+)\\\\)/.exec(s);o&&(e.rotate=parseFloat(o[1])),/\\\\s*translate\\\\(([-0-9.]+),([-0-9.]+)\\\\)scale\\\\(([-0-9.]+)\\\\)/.exec(s)&&(e.translateBeforeScale=!0);const i=/\\\\s*matrix\\\\(([-0-9.]+),([-0-9.]+),([-0-9.]+),([-0-9.]+),([-0-9.]+),([-0-9.]+)\\\\)/.exec(s);i&&(e.scaleX=parseFloat(i[1]),e.scaleY=parseFloat(i[4]),e.translateX=parseFloat(i[5]),e.translateY=parseFloat(i[6]))}return e}static addTransforms(t,e){return{translateX:t.translateX+e.translateX,translateY:t.translateY+e.translateY,scaleX:t.scaleX*e.scaleX,scaleY:t.scaleY*e.scaleY,rotate:t.rotate+e.rotate}}static convertSizeToPx(t,e=!0){const s=e?14:void 0;return void 0===t?s:\\\"number\\\"==typeof t?t:\\\"em\\\"===t.substr(-2)?Math.round(12*parseFloat(t)):\\\"px\\\"===t.substr(-2)?parseInt(t):t.match(/^[0-9]+$/)?parseInt(t):(console.warn(\\\"size in unsupported format: \\\",t),s)}static colorToRgba(t,e=1){if(!t||\\\"none\\\"===t)return\\\"none\\\";if(t=r.CssNamedColorToHex(t),1===e&&\\\"string\\\"==typeof t)return t;if(\\\"string\\\"==typeof t&&\\\"#\\\"===t[0]){let s;if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(t))return 3==(s=t.substring(1)).length&&(s=s[0]+s[0]+s[1]+s[1]+s[2]+s[2]),\\\"rgba(\\\"+[(s=\\\"0x\\\"+s)>>16&255,s>>8&255,255&s].join(\\\",\\\")+\\\",\\\"+e+\\\")\\\";throw new Error(\\\"Bad Hex\\\")}if(\\\"object\\\"==typeof t){if(\\\"r\\\"in t)return\\\"rgba(\\\"+t.r+\\\",\\\"+t.g+\\\",\\\"+t.b+\\\",\\\"+e+\\\")\\\";if(\\\"h\\\"in t){const s=r.hslToRgb(t.h/360,t.s,t.l);return\\\"rgba(\\\"+s.r+\\\",\\\"+s.g+\\\",\\\"+s.b+\\\",\\\"+e+\\\")\\\"}}else if(\\\"rgb(\\\"===t.substr(0,4))return t.substr(0,t.length-1).replace(\\\"rgb\\\",\\\"rgba\\\")+\\\", \\\"+e+\\\")\\\";return t}static hslToRgb(t,e,s){var r,l,o;if(0==e)r=l=o=s;else{var i=function(t,e,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?t+6*(e-t)*s:s<.5?e:s<2/3?t+(e-t)*(2/3-s)*6:t},n=s<.5?s*(1+e):s+e-s*e,a=2*s-n;r=i(a,n,t+1/3),l=i(a,n,t),o=i(a,n,t-1/3)}return{r:Math.round(255*r),g:Math.round(255*l),b:Math.round(255*o)}}static CssNamedColorToHex(t){return\\\"red\\\"===t?\\\"#ff0000\\\":\\\"steelblue\\\"===t?\\\"#4682b4\\\":\\\"black\\\"===t?\\\"#000000\\\":t}}e.default=r},function(t,e,s){\\\"use strict\\\";var r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,\\\"__esModule\\\",{value:!0});const l=s(2),o=r(s(3));let i;const n=self;let a;n.onmessage=function(t){const e=t.data;if(e&&e.cmd)switch(e.cmd){case\\\"INIT\\\":a=new l.VdomManager(e.data.visData);const t=!!e.data.safeMode;i=new o.default(a,e.data.canvas,t,()=>{n.postMessage({msg:\\\"DRAWN\\\"})});break;case\\\"UPDATE_NODES\\\":const s=e;for(let t of s.data.enterExit)if(\\\"ENTER\\\"===t.cmd){t.keepChildren||(t.node.children=[]);const e=a.addNode(t.node,t.parentNodeSelector);i.addNode&&i.addNode(e)}else\\\"EXIT\\\"===t.cmd&&a.removeNode(t.childIndex,t.parentNodeSelector);i.updatePropertiesFromQueue?i.updatePropertiesFromQueue(s.data.update):a.updatePropertiesFromQueue(s.data.update),i.draw();break;default:console.error(\\\"did not find command \\\",e.cmd)}}},function(t,e,s){\\\"use strict\\\";var r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,\\\"__esModule\\\",{value:!0});const l=r(s(0));e.SetPropertyQueue=class{};class o{constructor(t,e=!1){this.data=t,this.ignoreDesign=e,this.cachedListSelections={}}enableFrontendDesignProperties(){this.ignoreDesign=!1}addNode(t,e){let s=this.getVisNodeFromSelector(e);return s||(\\\"\\\"===e?s=this.data:console.error(s,e)),this.applyParentStyles(s,t),s&&s.children||console.error(\\\"parent node not found or no children: \\\",s,e,this.data),s.children.push(t),t}removeNode(t,e){let s=this.getVisNodeFromSelector(e);s||(\\\"\\\"===e?s=this.data:console.error(s,e)),s.children.splice(t,1),this.cachedListSelections={}}applyParentStyles(t,e){for(const s in t.style)e.style[s]||(e.style[s]=t.style[s])}getParentNodeFromSelector(t){let e;return t||console.error(\\\"no parent selector\\\",t),(e=\\\"SVG_PARENT\\\"===t?{children:[this.data]}:this.getVisNodeFromSelector(t))||console.error(\\\"parent node not found with selector\\\",t),e}applyStyleToNodeAndChildren(t,e,s){if(t.style[e]=s,t.children)for(let r of t.children)this.applyStyleToNodeAndChildren(r,e,s)}updatePropertiesFromQueue(t){for(let e in t){if(!t[e])continue;const s=this.getParentNodeFromSelector(e);if(s)for(let r in t[e]){const l=r.substr(0,\\\"style;\\\".length);if(this.ignoreDesign&&(\\\"style;\\\"===l||-1!==[\\\"fill\\\",\\\"stroke\\\",\\\"opacity\\\",\\\"x1\\\",\\\"x2\\\",\\\"y1\\\",\\\"y2\\\"].indexOf(r)))continue;let i,n;\\\"SharedArrayBuffer\\\"in self&&t[e][r]instanceof SharedArrayBuffer?(i=new Int32Array(t[e][r]),n=.1):i=t[e][r];for(let t in i){const e=s.children[t];if(!e)continue;let a=n?n*i[t]:i[t];if(\\\"style;\\\"===l){const t=r.substr(\\\"style;\\\".length);this.applyStyleToNodeAndChildren(e,t,a),this.updateDeducedStyles(e,t,a)}else-1!==o.ROUNDED_ATTRS.indexOf(r)&&(a=Math.round(a)),e[r]=a,this.updateDeducedStyles(e,r,a)}}else console.error(\\\"parent not found\\\",e,t[e])}}updateDeducedStyles(t,e,s){if(-1!==[\\\"opacity\\\",\\\"fill-opacity\\\",\\\"stroke-opacity\\\",\\\"stroke\\\",\\\"fill\\\"].indexOf(e)){let e=t.style.stroke?t.style.stroke:t.stroke;if(e){let s=void 0===t.style[\\\"stroke-opacity\\\"]?t.style.opacity:t.style[\\\"stroke-opacity\\\"];void 0===s&&(s=void 0===t[\\\"stroke-opacity\\\"]?t.opacity:t[\\\"stroke-opacity\\\"]),t.style[\\\"stroke-rgba\\\"]=l.default.colorToRgba(e,s)}}}getVisNodeFromSelector(t){const e=t.lastIndexOf(\\\">\\\"),s=t.substr(0,e),r=t.substr(e+1),l=s?this.cachedListSelections[s]:null;let o=-1;const i=r.indexOf(\\\":nth-child(\\\");if(-1!==i&&(o=parseInt(r.substr(i+11)),l&&l[o]))return l[o];const n=[];if(this.findMatchingChildren(this.data,t,0,n),n&&1===n.length){const t=n[0];return-1!==o&&(this.cachedListSelections[s]||(this.cachedListSelections[s]={}),this.cachedListSelections[s][o]=t),t}return null}getVisNodesFromSelector(t,e){const s=[];return this.findMatchingChildren(t,e,0,s),s}findChildrenOfType(t,e,s){const r=t=>{for(const l of t.children)l.type===e&&s.push(l),0!==t.children.length&&r(l)};r(t)}filterNodesBySelector(t,e,s){return e.filter(e=>o.isCssRulePartialMatch(s,e,t))}findMatchingChildren(t,e,s,r,l=[]){if(!e&&\\\"\\\"!==e)throw console.error(t,e,s,r,l),Error(\\\"undefined selector\\\");let i=e.split(\\\">\\\").map(t=>t.trim()),n=i[s];if(0===s&&\\\"svg\\\"===n&&(n=i[++s],s===i.length))return r.push(t),void l.push(e);if(e.match(/^[a-z]+$/))return this.findChildrenOfType(t,e,r);for(let a=0;a<t.children.length;a++){let c=t.children[a],h=!1;o.isCssRulePartialMatch(n,c,t)&&(s===i.length-1?(r.push(c),l.push(e)):h=!0),c.children&&(h||i.length<2)&&s+1<i.length&&this.findMatchingChildren(c,e,s+1,r,l)}}static isCssRulePartialMatch(t,e,s){if(\\\":not(\\\"===t.substr(0,5)){const r=t.substr(0,t.length-1).substr(5);return!o.isCssRulePartialMatch(r,e,s)}if(\\\".\\\"===t[0]){if(e.className&&-1!==e.className.split(\\\" \\\").indexOf(t.substr(1)))return!0}else if(\\\"#\\\"===t[0]){if(t.substr(1)===e.id)return!0}else if(t.match(/^[a-z]+$/)){if(t===e.type)return!0}else{if(-1!==t.indexOf(\\\":nth-child(\\\")){let r=\\\"any\\\",l=t;\\\":\\\"!==t[0]&&(r=t.substr(0,t.indexOf(\\\":\\\")),l=t.substr(t.indexOf(\\\":\\\")));const o=parseInt(l.substr(\\\":nth-child(\\\".length));return s.children.indexOf(e)===o-1&&(\\\"any\\\"===r||e.type===r)}if(-1!==t.indexOf(\\\".\\\")){const s=t.indexOf(\\\".\\\"),r=t.substr(0,s),l=t.substr(s+1);if(r===e.type&&e.className&&-1!==e.className.split(\\\" \\\").indexOf(l))return!0}}return!1}}o.ROUNDED_ATTRS=[\\\"cx\\\",\\\"cy\\\"],e.VdomManager=o},function(t,e,s){\\\"use strict\\\";var r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,\\\"__esModule\\\",{value:!0});const l=r(s(0));e.default=class{constructor(t,e,s=!1,r=(()=>{})){this.vdom=t,this.canvas=e,this.forceSingle=s,this.onDrawn=r,this.lastFullSecond=0,this.countSinceLastFullSecond=0,this.circlesByColor={},this.rectsByColor={},this.drawTexts=[],this.linesByColor={};const l=e.getContext(\\\"2d\\\");if(!l)throw new Error(\\\"could not create canvas context\\\");this.ctx=l,this.ctx.scale(this.vdom.data.scale,this.vdom.data.scale),this.ctx.save(),this.draw(),setTimeout(()=>{console.log(this.forceSingle,this.vdom.data),this.draw()},1e3)}draw(){const t=this.ctx;t.restore(),t.save(),t.clearRect(0,0,this.vdom.data.width,this.vdom.data.height),this.drawLine(null,\\\"start\\\"),this.drawCircle(null,\\\"start\\\"),this.drawRect(null,\\\"start\\\"),this.drawText(null,\\\"start\\\"),this.drawNodeAndChildren(this.vdom.data,this.forceSingle),this.drawLine(null,\\\"end\\\"),this.drawCircle(null,\\\"end\\\"),this.drawRect(null,\\\"end\\\"),this.drawText(null,\\\"end\\\"),this.onDrawn();const e=Math.round(performance.now()/1e3);e!==this.lastFullSecond&&(this.lastFullSecond=e,this.countSinceLastFullSecond=0),this.countSinceLastFullSecond++}drawNodeAndChildren(t,e){const s=this.ctx;if(s.save(),this.applyTransform(t.transform),t.transform&&(e=!0),t.type&&\\\"g\\\"!==t.type&&(!t.style.display||\\\"none\\\"!==t.style.display)){if(\\\"title\\\"===t.type)return;e?this.drawSingleNode(t,\\\"forcesingle\\\"):this.drawSingleNode(t)}if(t.children)for(let s=0;s<t.children.length;s++)this.drawNodeAndChildren(t.children[s],e);s.restore()}drawSingleNode(t,e=\\\"normal\\\"){const s=t.type,r=this[\\\"draw\\\"+s.substr(0,1).toUpperCase()+s.substr(1)];if(!r)return console.error(\\\"no draw function yet for \\\",s);r.call(this,t,e)}drawClippath(t){console.warn(\\\"clippaths can not be rendered yet.\\\")}drawCircle(t,e=\\\"normal\\\"){if(\\\"normal\\\"===e){let e=t.style.fill?t.style.fill:t.fill,s=t.style[\\\"fill-opacity\\\"]?t.style[\\\"fill-opacity\\\"]:t.style.opacity;e||(e=\\\"rgb(0,0,0)\\\");const r=l.default.colorToRgba(e,s)+\\\";\\\"+this.getStrokeStyle(t);this.circlesByColor[r]||(this.circlesByColor[r]=[]),this.circlesByColor[r].push(t)}if(\\\"start\\\"!==e){if(\\\"end\\\"!==e){if(\\\"forcesingle\\\"===e){let e=t.style.fill?t.style.fill:t.fill;e||(e=\\\"#000\\\");let s=t.style[\\\"fill-opacity\\\"]?t.style[\\\"fill-opacity\\\"]:t.style.opacity;const r=t.cx||0,o=t.cy||0;this.ctx.beginPath(),this.ctx.fillStyle=l.default.colorToRgba(e,s),this.ctx.strokeStyle=this.getStrokeStyle(t),this.ctx.lineWidth=t.style[\\\"stroke-width\\\"]?parseFloat(t.style[\\\"stroke-width\\\"]):parseFloat(t.strokeWidth),this.ctx.arc(r,o,t.r,0,2*Math.PI),\\\"none\\\"!==e&&this.ctx.fill(),t.style[\\\"stroke-rgba\\\"]&&\\\"none\\\"!==t.style[\\\"stroke-rgba\\\"]&&this.ctx.stroke()}}else for(let t in this.circlesByColor)if(this.circlesByColor.hasOwnProperty(t)){const e=t.split(\\\";\\\"),s=e[0],r=e[1];this.ctx.fillStyle=s;let l=this.circlesByColor[t][0];const o=l.style[\\\"stroke-width\\\"]?parseFloat(l.style[\\\"stroke-width\\\"]):parseFloat(l.strokeWidth);this.ctx.lineWidth=o||1,this.ctx.strokeStyle=r,this.ctx.beginPath();for(let e of this.circlesByColor[t]){const t=e.cx?e.cx:0,s=e.cy?e.cy:0,r=e.r;this.ctx.save(),this.applyTransform(e.transform),this.ctx.moveTo(t+r,s),this.ctx.arc(t,s,r,0,2*Math.PI),this.ctx.restore()}\\\"none\\\"!==s&&this.ctx.fill(),l.style[\\\"stroke-rgba\\\"]&&\\\"none\\\"!==l.style[\\\"stroke-rgba\\\"]&&this.ctx.stroke()}}else this.circlesByColor={}}getFillStyle(t){let e=t.style.fill?t.style.fill:t.fill,s=t.style[\\\"fill-opacity\\\"]?t.style[\\\"fill-opacity\\\"]:t.style.opacity;return e=l.default.colorToRgba(e,s)}getStrokeStyle(t){if(t.style[\\\"stroke-rgba\\\"])return t.style[\\\"stroke-rgba\\\"];let e=t.style.stroke?t.style.stroke:t.stroke;if(e){let s=void 0===t.style[\\\"stroke-opacity\\\"]?t.style.opacity:t.style[\\\"stroke-opacity\\\"];return void 0===s&&(s=void 0===t[\\\"stroke-opacity\\\"]?t.opacity:t[\\\"stroke-opacity\\\"]),t.style[\\\"stroke-rgba\\\"]=l.default.colorToRgba(e,s),t.style[\\\"stroke-rgba\\\"]}return\\\"none\\\"}drawRect(t,e=\\\"normal\\\"){if(\\\"normal\\\"===e){let e=t.style.fill?t.style.fill:t.fill,s=t[\\\"fill-opacity\\\"]?t[\\\"fill-opacity\\\"]:t.opacity,r=t.style[\\\"fill-opacity\\\"]?t.style[\\\"fill-opacity\\\"]:t.style.opacity;void 0!==r&&(s=r);const o=l.default.colorToRgba(e,s)+\\\";\\\"+this.getStrokeStyle(t);this.rectsByColor[o]||(this.rectsByColor[o]=[]),this.rectsByColor[o].push(t)}if(\\\"start\\\"!==e){if(\\\"end\\\"!==e){if(\\\"forcesingle\\\"===e){let e=t.style.fill?t.style.fill:t.fill;e&&(e=l.default.colorToRgba(e,t.style[\\\"fill-opacity\\\"])),e&&\\\"none\\\"!==e&&(this.ctx.fillStyle=t.style.fill?t.style.fill:t.fill,this.ctx.fillRect(t.x,t.y,t.width,t.height));let s=t.style.stroke?t.style.stroke:t.stroke;s&&(s=l.default.colorToRgba(s,t.style[\\\"stroke-opacity\\\"]),this.ctx.strokeStyle=s,this.ctx.beginPath(),this.ctx.rect(t.x,t.y,t.width,t.height),this.ctx.stroke())}}else for(let t in this.rectsByColor)if(this.rectsByColor.hasOwnProperty(t)){const e=t.split(\\\";\\\"),s=e[0],r=e[1];this.ctx.fillStyle=s;let l=this.rectsByColor[t][0];const o=l.style[\\\"stroke-width\\\"]?parseFloat(l.style[\\\"stroke-width\\\"]):parseFloat(l.strokeWidth);this.ctx.lineWidth=o||1,this.ctx.strokeStyle=r,this.ctx.beginPath();for(let e of this.rectsByColor[t]){const t=e.cx?e.cx:0,s=e.cy?e.cy:0,r=e.r;this.ctx.save(),this.applyTransform(e.transform),this.ctx.moveTo(t+r,s),this.ctx.rect(e.x,e.y,e.width,e.height),this.ctx.restore()}\\\"none\\\"!==s&&this.ctx.fill(),l.style[\\\"stroke-rgba\\\"]&&\\\"none\\\"!==l.style[\\\"stroke-rgba\\\"]&&this.ctx.stroke()}}else this.rectsByColor={}}drawText(t,e=\\\"normal\\\"){const s=t=>{if(\\\"\\\"===t.text)return;const e=t[\\\"font-size\\\"]?l.default.convertSizeToPx(t[\\\"font-size\\\"])+\\\"px\\\":\\\"30px\\\";let s=t.style.font?t.style.font:t.font;if(s||(s=e+\\\" Arial\\\"),t[\\\"text-anchor\\\"]){const e=\\\"middle\\\"===t[\\\"text-anchor\\\"]?\\\"center\\\":t[\\\"text-anchor\\\"];this.ctx.textAlign=e}let r=t.fill?t.fill:t.style.fill;r||(r=\\\"#000\\\"),this.ctx.font=s,this.ctx.fillStyle=r;let o=t.x||0,i=t.y||0,n=l.default.convertSizeToPx(t.dx,!1)||0,a=l.default.convertSizeToPx(t.dy,!1)||0;this.ctx.fillText(t.text,o+n,i+a)};if(\\\"start\\\"!==e)if(\\\"normal\\\"!==e){if(\\\"forcesingle\\\"===e)return s(t);if(\\\"end\\\"!==e);else for(const t of this.drawTexts)s(t)}else this.drawTexts.push(t);else this.drawTexts=[]}drawPath(t,e=\\\"normal\\\"){if(\\\"normal\\\"!==e&&\\\"forcesingle\\\"!==e)return;const s=this.getFillStyle(t),r=this.getStrokeStyle(t),l=t.style[\\\"stroke-width\\\"]?t.style[\\\"stroke-width\\\"]:t[\\\"stroke-width\\\"];let o=new Path2D(t.d);if(this.ctx.fillStyle=s,r&&\\\"none\\\"!==r){if(l?(this.ctx.lineWidth=l,this.ctx.strokeStyle=r):this.ctx.strokeStyle=r,t.style[\\\"stroke-linejoin\\\"]){const e=t.style[\\\"stroke-linejoin\\\"];\\\"bevel\\\"===e||\\\"round\\\"===e||\\\"miter\\\"===e?this.ctx.lineJoin=e:console.error(\\\"unknown line join value:\\\",e)}this.ctx.stroke(o)}s&&\\\"none\\\"!==s&&this.ctx.fill(o)}drawTspan(t,e=\\\"normal\\\"){if(\\\"normal\\\"!==e&&\\\"forcesingle\\\"!==e)return;this.ctx.font=\\\"10px Arial\\\",this.ctx.fillStyle=\\\"#000000\\\";const s=\\\"middle\\\"===t.style.textAnchor?\\\"center\\\":t.style.textAnchor;this.ctx.textAlign=s,this.ctx.fillText(t.text,t.x,t.y)}drawTextpath(t){console.warn(\\\"no draw function yet for textpath\\\")}drawLine(t,e=\\\"normal\\\"){if(this.vdom.data.scale,\\\"normal\\\"===e){const e=this.getStrokeStyle(t);if(\\\"none\\\"===e)return;this.linesByColor[e]||(this.linesByColor[e]=[]),this.linesByColor[e].push(t)}if(\\\"start\\\"!==e){if(\\\"end\\\"!==e)\\\"forcesingle\\\"===e&&(this.ctx.beginPath(),this.ctx.moveTo(t.x1,t.y1),this.ctx.lineTo(t.x2,t.y2),this.ctx.strokeStyle=t.style[\\\"stroke-rgba\\\"],this.ctx.stroke());else for(let t in this.linesByColor)if(this.linesByColor.hasOwnProperty(t)){this.ctx.strokeStyle=t;let e=this.linesByColor[t][0];this.ctx.lineWidth=e.style[\\\"stroke-width\\\"]?parseFloat(e.style[\\\"stroke-width\\\"]):parseFloat(e[\\\"stroke-width\\\"]),this.ctx.beginPath();for(let e of this.linesByColor[t])this.ctx.save(),this.applyTransform(e.transform),this.ctx.moveTo(e.x1,e.y1),this.ctx.lineTo(e.x2,e.y2),this.ctx.restore();this.ctx.stroke()}}else this.linesByColor={}}drawDefs(t){}drawMarker(t){}applyTransform(t){const e=t?l.default.parseTransform(t):null;return!!e&&(e.rotate,this.ctx.transform(e.scaleX,0,0,e.scaleY,e.translateX,e.translateY),this.ctx.rotate(e.rotate*Math.PI/180),!0)}}}]);\\n//# sourceMappingURL=0526c7d220676a730e70.worker.js.map\", __webpack_public_path__ + \"0526c7d220676a730e70.worker.js\");\n};","'use strict';\n\n// http://stackoverflow.com/questions/10343913/how-to-create-a-web-worker-from-a-string\n\nvar URL = window.URL || window.webkitURL;\n\nmodule.exports = function (content, url) {\n  try {\n    try {\n      var blob;\n\n      try {\n        // BlobBuilder = Deprecated, but widely implemented\n        var BlobBuilder = window.BlobBuilder || window.WebKitBlobBuilder || window.MozBlobBuilder || window.MSBlobBuilder;\n\n        blob = new BlobBuilder();\n\n        blob.append(content);\n\n        blob = blob.getBlob();\n      } catch (e) {\n        // The proposed API\n        blob = new Blob([content]);\n      }\n\n      return new Worker(URL.createObjectURL(blob));\n    } catch (e) {\n      return new Worker('data:application/javascript,' + encodeURIComponent(content));\n    }\n  } catch (e) {\n    if (!url) {\n      throw Error('Inline worker is not supported');\n    }\n\n    return new Worker(url);\n  }\n};"],"sourceRoot":""}